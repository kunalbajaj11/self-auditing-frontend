<div class="app-shell">
  <mat-sidenav-container class="shell-container">
    <mat-sidenav
      #drawer
      class="side-nav"
      [mode]="(isHandset$ | async) ? 'over' : 'side'"
      [opened]="!(isHandset$ | async)"
    >
      <div class="brand">
        <div class="brand-logo">
          <img src="assets/images/backless_logo.png" alt="SelfAccounting.AI Logo" class="logo-image" />
        </div>
        <div class="brand-label">
          <span class="brand-title">SelfAccounting.AI</span>
          <small class="brand-subtitle">Powered by <a href="https://stryvon.ai" target="_blank" rel="noopener noreferrer">stryvon.ai</a></small>
        </div>
      </div>
      <mat-nav-list #sideNavList>
        <ng-container *ngFor="let item of navItems">
          <ng-container *ngIf="item.children?.length; else singleLink">
            <div class="nav-group">
              <div 
                class="nav-group-header" 
                (click)="toggleNavGroup(item.label)"
                [class.expanded]="isNavGroupExpanded(item.label)"
              >
                <mat-icon class="nav-group-icon">{{ item.icon || 'folder' }}</mat-icon>
                <span>{{ item.label }}</span>
                <span class="badge" *ngIf="item.badgeCount$ | async as count">
                  {{ count }}
                </span>
                <mat-icon class="nav-group-chevron">
                  {{ isNavGroupExpanded(item.label) ? 'expand_less' : 'expand_more' }}
                </mat-icon>
              </div>
              <div 
                class="nav-group-children"
                [class.expanded]="isNavGroupExpanded(item.label)"
              >
                <ng-container *ngFor="let child of item.children">
                  <a
                    *ngIf="!isNavItemDisabled(child); else disabledChildLink"
                    mat-list-item
                    class="nav-child"
                    [routerLink]="child.route"
                    [queryParams]="child.queryParams"
                    routerLinkActive="active-child"
                    [routerLinkActiveOptions]="{ exact: true }"
                    (click)="closeDrawerIfHandset(drawer)"
                  >
                    <span>{{ child.label }}</span>
                    <span class="badge" *ngIf="child.badgeCount$ | async as count">
                      {{ count }}
                    </span>
                  </a>
                  <ng-template #disabledChildLink>
                    <div
                      mat-list-item
                      class="nav-child nav-disabled"
                      [matTooltip]="child.disabledReason || 'Locked'"
                    >
                      <span>{{ child.label }}</span>
                      <span class="badge" *ngIf="child.badgeCount$ | async as count">
                        {{ count }}
                      </span>
                      <mat-icon class="lock-icon">lock</mat-icon>
                    </div>
                  </ng-template>
                </ng-container>
              </div>
            </div>
          </ng-container>
          <ng-template #singleLink>
            <ng-container *ngIf="item.route">
              <a
                *ngIf="!isNavItemDisabled(item); else disabledSingleLink"
                mat-list-item
                class="nav-link"
                [routerLink]="item.route"
                [queryParams]="item.queryParams"
                routerLinkActive="active"
                [routerLinkActiveOptions]="{ exact: true }"
                (click)="closeDrawerIfHandset(drawer)"
              >
                <mat-icon matListIcon>{{ item.icon || 'chevron_right' }}</mat-icon>
                <span matLine>{{ item.label }}</span>
                <span class="badge" *ngIf="item.badgeCount$ | async as count">
                  {{ count }}
                </span>
              </a>
              <ng-template #disabledSingleLink>
                <div
                  mat-list-item
                  class="nav-link nav-disabled"
                  [matTooltip]="item.disabledReason || 'Locked'"
                >
                  <mat-icon matListIcon>{{ item.icon || 'chevron_right' }}</mat-icon>
                  <span matLine>{{ item.label }}</span>
                  <span class="badge" *ngIf="item.badgeCount$ | async as count">
                    {{ count }}
                  </span>
                  <mat-icon class="lock-icon">lock</mat-icon>
                </div>
              </ng-template>
            </ng-container>
          </ng-template>
        </ng-container>
      </mat-nav-list>
      <div class="side-footer">
        <div class="contact-info">
          <mat-icon>phone</mat-icon>
          <span class="contact-label">For queries:</span>
          <span class="contact-number">+971-58-900-3150</span>
        </div>
        <button mat-stroked-button color="primary" (click)="logout()">
          <mat-icon>logout</mat-icon>
          Sign out
        </button>
      </div>
    </mat-sidenav>

    <mat-sidenav-content class="content-area">
      <mat-toolbar color="primary" class="top-bar">
        <button
          mat-icon-button
          class="menu-button"
          (click)="drawer.toggle()"
          *ngIf="isHandset$ | async"
        >
          <mat-icon>menu</mat-icon>
        </button>
        <span class="page-title">
          <ng-container *ngIf="user$ | async as user">
            {{ user.organization?.name || 'SelfAccounting.AI' }}
          </ng-container>
        </span>

        <span class="spacer"></span>
        <button mat-icon-button aria-label="Notifications">
          <mat-icon>notifications</mat-icon>
        </button>
        <button mat-icon-button aria-label="Help">
          <mat-icon>help_outline</mat-icon>
        </button>
        <ng-container *ngIf="user$ | async as user">
          <div class="user-chip">
            <div class="user-avatar">
              {{ user.name | slice: 0:2 | uppercase }}
            </div>
            <div class="user-meta">
              <span class="user-name">{{ user.name }}</span>
              <small class="user-role">{{ user.role | titlecase }}</small>
            </div>
          </div>
        </ng-container>
      </mat-toolbar>

      <div class="content-wrapper">
        <main class="content">
          <router-outlet></router-outlet>
        </main>
      </div>
    </mat-sidenav-content>
  </mat-sidenav-container>
</div>

