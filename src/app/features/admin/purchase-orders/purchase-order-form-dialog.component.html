<h2 mat-dialog-title>
  {{ data ? 'Edit Purchase Order' : 'Create Purchase Order' }}
</h2>

<mat-dialog-content class="invoice-form-content">
  <form [formGroup]="form">
    <!-- Header Section -->
    <div class="form-section">
      <h3>Purchase Order Details</h3>
      <div class="form-row">
        <mat-form-field appearance="outline" class="flex-2">
          <mat-label>Vendor</mat-label>
          <input
            type="text"
            matInput
            formControlName="vendorName"
            [matAutocomplete]="vendorAuto"
            placeholder="Search or type vendor name"
          />
          <mat-autocomplete
            #vendorAuto="matAutocomplete"
            [displayWith]="displayVendor"
            (optionSelected)="onVendorSelected($event.option.value)"
            [panelWidth]="'auto'"
          >
            <mat-option *ngFor="let vendor of filteredVendors$ | async" [value]="vendor">
              <div class="vendor-option">
                <span class="vendor-name">{{ vendor.name }}</span>
                <span *ngIf="vendor.vendorTrn" class="vendor-trn">TRN: {{ vendor.vendorTrn }}</span>
              </div>
            </mat-option>
          </mat-autocomplete>
          <button
            *ngIf="selectedVendor"
            matSuffix
            mat-icon-button
            (click)="clearVendorSelection()"
            type="button"
            matTooltip="Clear vendor selection"
          >
            <mat-icon>close</mat-icon>
          </button>
        </mat-form-field>

        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>PO Date *</mat-label>
          <input matInput [matDatepicker]="poDatePicker" formControlName="poDate" placeholder="Select PO date" required />
          <mat-datepicker-toggle matIconSuffix [for]="poDatePicker"></mat-datepicker-toggle>
          <mat-datepicker #poDatePicker></mat-datepicker>
          <mat-error *ngIf="form.get('poDate')?.hasError('required')">
            PO date is required
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>Expected Delivery Date</mat-label>
          <input matInput [matDatepicker]="expectedDeliveryDatePicker" formControlName="expectedDeliveryDate" placeholder="Select delivery date" />
          <mat-datepicker-toggle matIconSuffix [for]="expectedDeliveryDatePicker"></mat-datepicker-toggle>
          <mat-datepicker #expectedDeliveryDatePicker></mat-datepicker>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>Vendor TRN</mat-label>
          <input matInput formControlName="vendorTrn" />
        </mat-form-field>

        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>Currency</mat-label>
          <mat-select formControlName="currency">
            <mat-option *ngFor="let curr of currencies" [value]="curr">
              {{ curr }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>
    </div>

    <!-- Line Items Section -->
    <div class="form-section">
      <div class="section-header">
        <h3>Line Items</h3>
        <button mat-button type="button" color="primary" (click)="addLineItem()">
          <mat-icon>add</mat-icon>
          Add Item
        </button>
      </div>

      <div class="line-items-container" formArrayName="lineItems">
        <!-- Shared autocomplete panel -->
        <mat-autocomplete
          #itemAuto="matAutocomplete"
          [displayWith]="displayItemName"
          (optionSelected)="onItemSelected(activeItemIndex !== null ? activeItemIndex : 0, $any($event).option.value)"
          [panelWidth]="'auto'"
        >
          <mat-option *ngFor="let suggestion of filteredItems$ | async" [value]="suggestion">
            <div class="item-suggestion">
              <span class="item-name">{{ suggestion.itemName }}</span>
              <span *ngIf="suggestion.description" class="item-description">{{ suggestion.description }}</span>
              <span class="item-details">
                {{ form.get('currency')?.value || 'AED' }} {{ suggestion.unitPrice | number: '1.2-2' }} 
                · VAT: {{ suggestion.vatRate }}% 
                · Used {{ suggestion.usageCount }} time{{ suggestion.usageCount !== 1 ? 's' : '' }}
              </span>
            </div>
          </mat-option>
        </mat-autocomplete>

        <table class="line-items-table" *ngIf="lineItems.length > 0">
          <thead>
            <tr>
              <th>Item Name *</th>
              <th>Description</th>
              <th>Qty *</th>
              <th>Unit</th>
              <th>Unit Price *</th>
              <th>VAT Rate</th>
              <th>VAT Type</th>
              <th>Amount</th>
              <th>VAT</th>
              <th>Total</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let lineItem of lineItems.controls; let i = index" [formGroupName]="i">
              <td>
                <div class="item-name-autocomplete">
                  <input
                    class="form-input"
                    formControlName="itemName"
                    placeholder="Item name"
                    [matAutocomplete]="itemAuto"
                    (focus)="onItemNameFocus(i)"
                  />
                </div>
                <small class="error-text" *ngIf="lineItem.get('itemName')?.hasError('required') && lineItem.get('itemName')?.touched">
                  Required
                </small>
              </td>
              <td>
                <input class="form-input" formControlName="description" placeholder="Description" />
              </td>
              <td>
                <input class="form-input" type="number" formControlName="orderedQuantity" step="0.001" min="0.001" style="width: 70px;" />
              </td>
              <td>
                <input class="form-input" formControlName="unitOfMeasure" placeholder="unit" style="width: 70px;" />
              </td>
              <td>
                <input class="form-input" type="number" formControlName="unitPrice" step="0.01" min="0" style="width: 100px;" />
              </td>
              <td>
                <input class="form-input" type="number" formControlName="vatRate" step="0.01" min="0" max="100" style="width: 70px;" />
              </td>
              <td>
                <select class="form-select" formControlName="vatTaxType" style="width: 120px;">
                  <option *ngFor="let type of vatTaxTypes" [value]="type">
                    {{ type }}
                  </option>
                </select>
              </td>
              <td class="readonly">{{ lineItem.get('amount')?.value | number: '1.2-2' }}</td>
              <td class="readonly">{{ lineItem.get('vatAmount')?.value | number: '1.2-2' }}</td>
              <td class="readonly">{{ lineItem.get('totalAmount')?.value | number: '1.2-2' }}</td>
              <td>
                <button mat-icon-button type="button" color="warn" (click)="removeLineItem(i)">
                  <mat-icon>delete</mat-icon>
                </button>
              </td>
            </tr>
          </tbody>
        </table>

        <div *ngIf="lineItems.length === 0" class="empty-line-items">
          <p>No line items. Click "Add Item" to add items to this purchase order.</p>
        </div>
      </div>

      <!-- Totals -->
      <div class="totals-section" *ngIf="lineItems.length > 0">
        <div class="totals-row">
          <span class="total-label">Subtotal:</span>
          <span class="total-value">{{ subtotal | number: '1.2-2' }} {{ form.get('currency')?.value }}</span>
        </div>
        <div class="totals-row">
          <span class="total-label">Total VAT:</span>
          <span class="total-value">{{ totalVat | number: '1.2-2' }} {{ form.get('currency')?.value }}</span>
        </div>
        <div class="totals-row total-amount">
          <span class="total-label">Total Amount:</span>
          <span class="total-value">{{ totalAmount | number: '1.2-2' }} {{ form.get('currency')?.value }}</span>
        </div>
      </div>
    </div>

    <!-- Notes Section -->
    <div class="form-section">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Notes</mat-label>
        <textarea matInput formControlName="notes" rows="3"></textarea>
      </mat-form-field>
    </div>
  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="cancel()" [disabled]="loading">Cancel</button>
  <button
    mat-raised-button
    color="primary"
    (click)="save()"
    [disabled]="form.invalid || loading || lineItems.length === 0"
  >
    <mat-spinner *ngIf="loading" diameter="20" class="inline-spinner"></mat-spinner>
    <span *ngIf="!loading">{{ data ? 'Update' : 'Create' }}</span>
  </button>
</mat-dialog-actions>
