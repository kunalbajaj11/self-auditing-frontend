<div class="sales-order-form-dialog">
  <header class="dialog-header">
    <div class="header-text">
      <h2 mat-dialog-title>
        <mat-icon>shopping_cart</mat-icon>
        {{ data ? 'Edit Sales Order' : 'New Sales Order' }}
      </h2>
      <p class="dialog-subtitle">
        {{ data ? 'Update order details and line items.' : 'Create a sales order for your customer.' }}
      </p>
    </div>
  </header>

  <mat-dialog-content class="content">
    <mat-progress-bar *ngIf="loading" mode="indeterminate"></mat-progress-bar>

    <form [formGroup]="form" class="form">
      <section class="form-section">
        <h3 class="section-title">
          <mat-icon>receipt_long</mat-icon>
          Order details
        </h3>
        <div class="grid">
      <mat-form-field appearance="outline">
        <mat-label>Customer</mat-label>
        <mat-select formControlName="customerId" (selectionChange)="onCustomerChange($event.value)">
          <mat-option value="">Manual</mat-option>
          <mat-option *ngFor="let c of customers" [value]="c.id">{{ c.name }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Customer Name</mat-label>
        <input matInput formControlName="customerName" />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Customer TRN</mat-label>
        <input matInput formControlName="customerTrn" />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Order Date</mat-label>
        <input matInput type="date" formControlName="orderDate" />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Expected Delivery Date</mat-label>
        <input matInput type="date" formControlName="expectedDeliveryDate" />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Currency</mat-label>
        <mat-select formControlName="currency">
          <mat-option *ngFor="let c of currencies" [value]="c">{{ c }}</mat-option>
        </mat-select>
      </mat-form-field>
        </div>

        <mat-form-field appearance="outline" class="full">
          <mat-label>Notes</mat-label>
          <textarea matInput formControlName="notes" rows="2"></textarea>
        </mat-form-field>
      </section>

      <section class="form-section line-items-section">
        <div class="line-items-header">
          <h3 class="section-title">
            <mat-icon>list_alt</mat-icon>
            Line Items
          </h3>
          <button mat-stroked-button type="button" (click)="addLineItem()">
            <mat-icon>add</mat-icon>
            Add item
          </button>
        </div>

        <div class="line-items-container" formArrayName="lineItems">
          <table class="line-items-table" *ngIf="lineItems.length > 0">
            <thead>
              <tr>
                <th>Product</th>
                <th>Item Name *</th>
                <th>Description</th>
                <th>Qty</th>
                <th>Unit</th>
                <th>Unit Price *</th>
                <th>VAT Rate</th>
                <th>VAT Type</th>
                <th>Amount</th>
                <th>VAT</th>
                <th>Total</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let lineItem of lineItems.controls; let i = index" [formGroupName]="i">
                <td>
                  <select class="form-select" formControlName="productId" (change)="onProductSelected(i)">
                    <option value="">Manual</option>
                    <option *ngFor="let p of products" [value]="p.id">
                      {{ p.name }}{{ p.sku ? ' (' + p.sku + ')' : '' }}
                    </option>
                  </select>
                </td>
                <td>
                  <input class="form-input" formControlName="itemName" placeholder="Item name" />
                  <small class="error-text" *ngIf="lineItem.get('itemName')?.hasError('required') && lineItem.get('itemName')?.touched">Required</small>
                </td>
                <td>
                  <input class="form-input" formControlName="description" placeholder="Description" />
                </td>
                <td>
                  <input class="form-input num" type="number" formControlName="orderedQuantity" step="0.001" min="0.001" />
                </td>
                <td>
                  <input class="form-input" formControlName="unitOfMeasure" placeholder="unit" />
                </td>
                <td>
                  <input class="form-input num" type="number" formControlName="unitPrice" step="0.01" min="0" />
                </td>
                <td>
                  <input class="form-input num" type="number" formControlName="vatRate" step="0.01" min="0" max="100" />
                </td>
                <td>
                  <select class="form-select" formControlName="vatTaxType">
                    <option *ngFor="let t of vatTaxTypes" [value]="t">{{ t }}</option>
                  </select>
                </td>
                <td class="readonly">{{ lineItem.get('amount')?.value | number: '1.2-2' }}</td>
                <td class="readonly">{{ lineItem.get('vatAmount')?.value | number: '1.2-2' }}</td>
                <td class="readonly">{{ lineItem.get('totalAmount')?.value | number: '1.2-2' }}</td>
                <td>
                  <button mat-icon-button type="button" color="warn" (click)="removeLineItem(i)" [disabled]="lineItems.length <= 1" matTooltip="Remove">
                    <mat-icon>delete</mat-icon>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>

          <div *ngIf="lineItems.length === 0" class="empty-line-items">
            <p>No line items. Click "Add item" to add items to this sales order.</p>
          </div>
        </div>

        <div class="totals-section" *ngIf="lineItems.length > 0">
          <div class="totals-row">
            <span class="total-label">Subtotal:</span>
            <span class="total-value">{{ subtotal | number: '1.2-2' }} {{ form.get('currency')?.value }}</span>
          </div>
          <div class="totals-row">
            <span class="total-label">Total VAT:</span>
            <span class="total-value">{{ totalVat | number: '1.2-2' }} {{ form.get('currency')?.value }}</span>
          </div>
          <div class="totals-row total-amount">
            <span class="total-label">Total Amount:</span>
            <span class="total-value">{{ totalAmount | number: '1.2-2' }} {{ form.get('currency')?.value }}</span>
          </div>
        </div>
      </section>
    </form>
  </mat-dialog-content>

  <mat-dialog-actions class="dialog-actions" align="end">
    <button mat-button (click)="cancel()" [disabled]="loading">Cancel</button>
    <button mat-raised-button color="primary" (click)="save()" [disabled]="loading" class="submit-btn">
      <mat-icon>save</mat-icon>
      Save
    </button>
  </mat-dialog-actions>
</div>

