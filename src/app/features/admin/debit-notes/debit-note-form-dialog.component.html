<div class="debit-note-form-dialog">
  <header class="dialog-header">
    <div class="header-text">
      <h2 mat-dialog-title>
        <mat-icon>redo</mat-icon>
        {{ data ? 'Edit Debit Note' : 'Create Debit Note' }}
      </h2>
      <p class="dialog-subtitle">
        {{ data ? 'Update debit note details.' : 'Issue a debit note for a supplier (e.g. return or adjustment).' }}
      </p>
    </div>
  </header>

  <mat-dialog-content class="debit-note-form-content">
    <form [formGroup]="form" class="debit-note-form">
      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>receipt_long</mat-icon>
          Debit note details
        </h3>
      <div class="form-row">
        <mat-form-field appearance="outline" class="flex-2 related-expense-field">
          <mat-label>Related Expense (Optional)</mat-label>
          <mat-select formControlName="expenseId" (selectionChange)="onExpenseChange($event.value)" [disableOptionCentering]="true">
            <mat-option [value]="null">No Expense</mat-option>
            <mat-option *ngFor="let expense of expenses" [value]="expense.id">
              {{ expense.invoiceNumber || expense.id }} - {{ expense.vendorName || 'N/A' }} ({{ expense.totalAmount | number: '1.2-2' }} {{ expense.currency }})
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>Debit Note Date *</mat-label>
          <input matInput [matDatepicker]="debitNoteDatePicker" formControlName="debitNoteDate" placeholder="Select date" required />
          <mat-datepicker-toggle matIconSuffix [for]="debitNoteDatePicker"></mat-datepicker-toggle>
          <mat-datepicker #debitNoteDatePicker></mat-datepicker>
          <mat-error *ngIf="form.get('debitNoteDate')?.hasError('required')">
            Date is required
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>Reason *</mat-label>
          <mat-select formControlName="reason" required>
            <mat-option *ngFor="let reason of debitNoteReasons" [value]="reason.value">
              {{ reason.label }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="form.get('reason')?.hasError('required')">
            Reason is required
          </mat-error>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="flex-2">
          <mat-label>Supplier/Vendor</mat-label>
          <mat-select formControlName="vendorId" (selectionChange)="onVendorChange($event.value)">
            <mat-option [value]="null">Select Supplier</mat-option>
            <mat-option *ngFor="let vendor of vendors" [value]="vendor.id">
              {{ vendor.name }} {{ vendor.vendorTrn ? '(' + vendor.vendorTrn + ')' : '' }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>Supplier Name</mat-label>
          <input matInput formControlName="vendorName" placeholder="Or enter manually" />
        </mat-form-field>

        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>Supplier TRN</mat-label>
          <input matInput formControlName="vendorTrn" />
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>Amount *</mat-label>
          <input matInput type="number" formControlName="amount" step="0.01" min="0.01" required />
          <span matSuffix>{{ form.get('currency')?.value }}</span>
          <mat-error *ngIf="form.get('amount')?.hasError('required')">
            Amount is required
          </mat-error>
          <mat-error *ngIf="form.get('amount')?.hasError('min')">
            Amount must be greater than 0
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="flex-1 vat-amount-field">
          <mat-label>VAT Amount</mat-label>
          <input matInput type="text" formControlName="vatAmount" step="0.01" min="0" />
          <span matSuffix>{{ form.get('currency')?.value }}</span>
          <button mat-icon-button matSuffix type="button" (click)="calculateVat()" matTooltip="Auto-calculate 5% VAT">
            <mat-icon>calculate</mat-icon>
          </button>
        </mat-form-field>

        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>Currency</mat-label>
          <mat-select formControlName="currency">
            <mat-option *ngFor="let curr of currencies" [value]="curr">
              {{ curr }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>Status</mat-label>
          <mat-select formControlName="status">
            <mat-option *ngFor="let status of debitNoteStatuses" [value]="status">
              {{ status | titlecase }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="totals-row">
        <span class="total-label">Total Amount:</span>
        <span class="total-value">{{ totalAmount | number: '1.2-2' }} {{ form.get('currency')?.value }}</span>
      </div>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Description</mat-label>
        <textarea matInput formControlName="description" rows="2"></textarea>
      </mat-form-field>
    </div>

    <div class="form-section">
      <h3 class="section-title">
        <mat-icon>notes</mat-icon>
        Notes
      </h3>
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Notes</mat-label>
        <textarea matInput formControlName="notes" rows="3"></textarea>
      </mat-form-field>
    </div>
  </form>
</mat-dialog-content>

  <mat-dialog-actions class="dialog-actions" align="end">
    <button mat-button (click)="cancel()" [disabled]="loading">Cancel</button>
    <button
      mat-raised-button
      color="primary"
      (click)="save()"
      [disabled]="form.invalid || loading"
      class="submit-btn"
    >
      <mat-spinner *ngIf="loading" diameter="20" class="inline-spinner"></mat-spinner>
      <mat-icon *ngIf="!loading">{{ data ? 'save' : 'add_circle' }}</mat-icon>
      <span *ngIf="!loading">{{ data ? 'Update' : 'Create' }}</span>
    </button>
  </mat-dialog-actions>
</div>

