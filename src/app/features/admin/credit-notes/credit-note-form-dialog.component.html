<div class="credit-note-form-dialog">
  <header class="dialog-header">
    <div class="header-text">
      <h2 mat-dialog-title>
        <mat-icon>undo</mat-icon>
        {{ data ? 'Edit Credit Note' : 'Create Credit Note' }}
      </h2>
      <p class="dialog-subtitle">
        {{ data ? 'Update credit note details.' : 'Issue a credit note for a customer (e.g. return or discount).' }}
      </p>
    </div>
  </header>

  <mat-dialog-content class="credit-note-form-content">
    <form [formGroup]="form" class="credit-note-form">
      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>receipt_long</mat-icon>
          Credit note details
        </h3>
      <div class="form-row">
        <mat-form-field appearance="outline" class="flex-2 related-invoice-field">
          <mat-label>Related Invoice (Optional)</mat-label>
          <mat-select formControlName="invoiceId" (selectionChange)="onInvoiceChange($event.value)" [disableOptionCentering]="true">
            <mat-option [value]="null">No Invoice</mat-option>
            <mat-option *ngFor="let invoice of invoices" [value]="invoice.id">
              {{ invoice.invoiceNumber }} - {{ invoice.customerName || 'N/A' }} ({{ invoice.totalAmount | number: '1.2-2' }} {{ invoice.currency }})
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>Credit Note Date *</mat-label>
          <input matInput [matDatepicker]="creditNoteDatePicker" formControlName="creditNoteDate" placeholder="Select date" required />
          <mat-datepicker-toggle matIconSuffix [for]="creditNoteDatePicker"></mat-datepicker-toggle>
          <mat-datepicker #creditNoteDatePicker></mat-datepicker>
          <mat-error *ngIf="form.get('creditNoteDate')?.hasError('required')">
            Date is required
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>Reason *</mat-label>
          <mat-select formControlName="reason" required>
            <mat-option *ngFor="let reason of creditNoteReasons" [value]="reason.value">
              {{ reason.label }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="form.get('reason')?.hasError('required')">
            Reason is required
          </mat-error>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="flex-2">
          <mat-label>Customer</mat-label>
          <mat-select formControlName="customerId" (selectionChange)="onCustomerChange($event.value)">
            <mat-option [value]="null">Select Customer</mat-option>
            <mat-option *ngFor="let customer of customers" [value]="customer.id">
              {{ customer.name }} {{ customer.customerTrn ? '(' + customer.customerTrn + ')' : '' }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>Customer Name</mat-label>
          <input matInput formControlName="customerName" placeholder="Or enter manually" />
        </mat-form-field>

        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>Customer TRN</mat-label>
          <input matInput formControlName="customerTrn" />
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>Amount *</mat-label>
          <input matInput type="number" formControlName="amount" step="0.01" min="0.01" required />
          <span matSuffix>{{ form.get('currency')?.value }}</span>
          <mat-error *ngIf="form.get('amount')?.hasError('required')">
            Amount is required
          </mat-error>
          <mat-error *ngIf="form.get('amount')?.hasError('min')">
            Amount must be greater than 0
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="flex-1 vat-amount-field">
          <mat-label>VAT Amount</mat-label>
          <input matInput type="text" formControlName="vatAmount" step="0.01" min="0" />
          <span matSuffix>{{ form.get('currency')?.value }}</span>
          <button mat-icon-button matSuffix type="button" (click)="calculateVat()" matTooltip="Auto-calculate 5% VAT">
            <mat-icon>calculate</mat-icon>
          </button>
        </mat-form-field>

        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>Currency</mat-label>
          <mat-select formControlName="currency">
            <mat-option *ngFor="let curr of currencies" [value]="curr">
              {{ curr }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>Status</mat-label>
          <mat-select formControlName="status">
            <mat-option *ngFor="let status of creditNoteStatuses" [value]="status">
              {{ status | titlecase }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="totals-row">
        <span class="total-label">Total Amount:</span>
        <span class="total-value">{{ totalAmount | number: '1.2-2' }} {{ form.get('currency')?.value }}</span>
      </div>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Description</mat-label>
        <textarea matInput formControlName="description" rows="2"></textarea>
      </mat-form-field>
    </div>

    <div class="form-section">
      <h3 class="section-title">
        <mat-icon>notes</mat-icon>
        Notes
      </h3>
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Notes</mat-label>
        <textarea matInput formControlName="notes" rows="3"></textarea>
      </mat-form-field>
    </div>
  </form>
</mat-dialog-content>

  <mat-dialog-actions class="dialog-actions" align="end">
    <button mat-button (click)="cancel()" [disabled]="loading">Cancel</button>
    <button
      mat-raised-button
      color="primary"
      (click)="save()"
      [disabled]="form.invalid || loading"
      class="submit-btn"
    >
      <mat-spinner *ngIf="loading" diameter="20" class="inline-spinner"></mat-spinner>
      <mat-icon *ngIf="!loading">{{ data ? 'save' : 'add_circle' }}</mat-icon>
      <span *ngIf="!loading">{{ data ? 'Update' : 'Create' }}</span>
    </button>
  </mat-dialog-actions>
</div>

