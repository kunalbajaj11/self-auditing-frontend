<h2 mat-dialog-title>
  {{ isEditMode ? 'Edit Journal Entry' : 'Add Journal Entry' }}
</h2>

<form mat-dialog-content [formGroup]="form" class="form">
  <!-- Entry Style Selection (for future multi-line support) -->
  <mat-form-field appearance="outline" *ngIf="false">
    <mat-label>Entry Style</mat-label>
    <mat-select formControlName="entryStyle">
      <mat-option value="simple">Simple Journal (1 debit, 1 credit)</mat-option>
      <mat-option value="multi" disabled>Multi-line (Coming Soon)</mat-option>
    </mat-select>
  </mat-form-field>

  <!-- Templates Section -->
  <div class="templates-section" *ngIf="!isEditMode">
    <h3>Quick Templates</h3>
    <div class="template-buttons">
      <button
        mat-stroked-button
        type="button"
        *ngFor="let template of templates"
        (click)="applyTemplate(template)"
        [class.selected]="selectedTemplate === template"
      >
        <mat-icon>description</mat-icon>
        {{ template.name }}
      </button>
    </div>
  </div>

  <!-- Balance Indicator -->
  <div class="balance-indicator" *ngIf="form.get('amount')?.value > 0">
    <div class="balance-row">
      <span class="balance-label">Debit:</span>
      <span class="balance-amount debit">AED {{ debitAmount | number: '1.2-2' }}</span>
    </div>
    <div class="balance-row">
      <span class="balance-label">Credit:</span>
      <span class="balance-amount credit">AED {{ creditAmount | number: '1.2-2' }}</span>
    </div>
    <div class="balance-status" [class.balanced]="isBalanced">
      <mat-icon *ngIf="isBalanced">check_circle</mat-icon>
      <mat-icon *ngIf="!isBalanced">error</mat-icon>
      <span>{{ isBalanced ? 'Balanced' : 'Unbalanced' }}</span>
    </div>
  </div>

  <!-- Date -->
  <mat-form-field appearance="outline">
    <mat-label>Entry Date *</mat-label>
    <input
      matInput
      [matDatepicker]="entryDatePicker"
      formControlName="entryDate"
      placeholder="Select entry date"
      required
    />
    <mat-datepicker-toggle matIconSuffix [for]="entryDatePicker"></mat-datepicker-toggle>
    <mat-datepicker #entryDatePicker></mat-datepicker>
    <mat-error *ngIf="form.get('entryDate')?.hasError('required')">
      Entry date is required
    </mat-error>
  </mat-form-field>

  <!-- Description -->
  <mat-form-field appearance="outline" class="full">
    <mat-label>Description / Narration</mat-label>
    <textarea matInput formControlName="description" rows="3" placeholder="Enter description of the transaction"></textarea>
  </mat-form-field>

  <!-- Amount -->
  <mat-form-field appearance="outline">
    <mat-label>Amount (AED) *</mat-label>
    <input matInput type="number" formControlName="amount" required step="0.01" min="0.01" />
    <mat-error *ngIf="form.get('amount')?.hasError('required')">
      Amount is required
    </mat-error>
    <mat-error *ngIf="form.get('amount')?.hasError('min')">
      Amount must be greater than 0
    </mat-error>
  </mat-form-field>

  <!-- Debit Account -->
  <mat-form-field appearance="outline">
    <mat-label>Debit Account *</mat-label>
    <mat-select formControlName="debitAccount" required>
      <mat-optgroup *ngFor="let category of ['asset', 'expense', 'liability']" [label]="category | titlecase">
        <mat-option
          *ngFor="let account of accountsByCategory[category]"
          [value]="account.code"
          [disabled]="account.isReadOnly"
        >
          {{ account.name }}
        </mat-option>
      </mat-optgroup>
      <mat-optgroup label="Equity">
        <mat-option
          *ngFor="let account of accountsByCategory['equity']"
          [value]="account.code"
          [disabled]="account.isReadOnly || account.code === 'retained_earnings'"
        >
          {{ account.name }}
        </mat-option>
      </mat-optgroup>
    </mat-select>
    <mat-error *ngIf="form.get('debitAccount')?.hasError('required')">
      Debit account is required
    </mat-error>
    <mat-error *ngIf="form.hasError('accountMismatch')">
      Debit and Credit accounts cannot be the same
    </mat-error>
    <mat-error *ngIf="form.hasError('retainedEarningsNotAllowed')">
      Retained Earnings is system-calculated and cannot be used
    </mat-error>
  </mat-form-field>

  <!-- Credit Account -->
  <mat-form-field appearance="outline">
    <mat-label>Credit Account *</mat-label>
    <mat-select formControlName="creditAccount" required>
      <mat-optgroup *ngFor="let category of ['liability', 'revenue']" [label]="category | titlecase">
        <mat-option
          *ngFor="let account of accountsByCategory[category]"
          [value]="account.code"
          [disabled]="account.isReadOnly"
        >
          {{ account.name }}
        </mat-option>
      </mat-optgroup>
      <mat-optgroup label="Equity">
        <mat-option
          *ngFor="let account of accountsByCategory['equity']"
          [value]="account.code"
          [disabled]="account.isReadOnly || account.code === 'retained_earnings'"
        >
          {{ account.name }}
        </mat-option>
      </mat-optgroup>
      <mat-optgroup label="Asset">
        <mat-option
          *ngFor="let account of accountsByCategory['asset']"
          [value]="account.code"
          [disabled]="account.isReadOnly"
        >
          {{ account.name }}
        </mat-option>
      </mat-optgroup>
    </mat-select>
    <mat-error *ngIf="form.get('creditAccount')?.hasError('required')">
      Credit account is required
    </mat-error>
  </mat-form-field>

  <!-- Optional Fields Section -->
  <div class="optional-fields-section">
    <h3 class="section-title">Optional Fields</h3>
    
    <!-- Customer / Vendor with Autocomplete -->
    <mat-form-field appearance="outline" class="full">
      <mat-label>Customer / Vendor</mat-label>
      <input
        matInput
        formControlName="customerVendorName"
        placeholder="Search vendor or customer name"
        [matAutocomplete]="vendorCustomerAuto"
        (focus)="onVendorCustomerFocus()"
      />
      <mat-autocomplete
        #vendorCustomerAuto="matAutocomplete"
        [displayWith]="displayVendorOrCustomer"
        (optionSelected)="onVendorOrCustomerSelected($event)"
      >
        <!-- Vendor Options -->
        <mat-optgroup label="Vendors" *ngIf="filteredVendors$ | async as vendors">
          <mat-option *ngFor="let vendor of vendors" [value]="vendor">
            <div class="autocomplete-option">
              <span class="option-name">{{ vendor.name }}</span>
              <span *ngIf="vendor.vendorTrn" class="option-trn">TRN: {{ vendor.vendorTrn }}</span>
            </div>
          </mat-option>
        </mat-optgroup>
        <!-- Customer Options -->
        <mat-optgroup label="Customers" *ngIf="filteredCustomers$ | async as customers">
          <mat-option *ngFor="let customer of customers" [value]="customer">
            <div class="autocomplete-option">
              <span class="option-name">{{ customer.name }}</span>
              <span *ngIf="customer.customerTrn" class="option-trn">TRN: {{ customer.customerTrn }}</span>
            </div>
          </mat-option>
        </mat-optgroup>
      </mat-autocomplete>
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>

    <!-- Vendor TRN (Auto-filled if vendor selected) -->
    <mat-form-field appearance="outline" class="full">
      <mat-label>Vendor TRN</mat-label>
      <input matInput formControlName="vendorTrn" placeholder="Enter vendor TRN (Tax Registration Number)" [readonly]="selectedVendor?.vendorTrn ? true : false" />
      <mat-hint *ngIf="selectedVendor?.vendorTrn">Auto-filled from vendor</mat-hint>
    </mat-form-field>

    <!-- Pending Invoices Section for Vendor -->
    <div class="pending-invoices-section" *ngIf="isVendorSelected">
      <h4 class="section-subtitle">
        <mat-icon>receipt</mat-icon>
        Pending Expense Invoices
      </h4>
      <div *ngIf="loadingPendingExpenseInvoices" class="loading-state">
        <mat-spinner diameter="24"></mat-spinner>
        <span>Loading pending invoices...</span>
      </div>
      <div *ngIf="!loadingPendingExpenseInvoices && pendingExpenseInvoices.length > 0" class="invoices-table-container">
        <table mat-table [dataSource]="pendingExpenseInvoices" class="pending-invoices-table">
          <ng-container matColumnDef="select">
            <th mat-header-cell *matHeaderCellDef>Select</th>
            <td mat-cell *matCellDef="let invoice">
              <button
                mat-icon-button
                color="primary"
                (click)="selectExpenseInvoice(invoice)"
                matTooltip="Select this invoice"
              >
                <mat-icon>check_circle</mat-icon>
              </button>
            </td>
          </ng-container>

          <ng-container matColumnDef="invoiceNumber">
            <th mat-header-cell *matHeaderCellDef>Invoice #</th>
            <td mat-cell *matCellDef="let invoice">
              <strong>{{ invoice.invoiceNumber || 'N/A' }}</strong>
            </td>
          </ng-container>

          <ng-container matColumnDef="date">
            <th mat-header-cell *matHeaderCellDef>Date</th>
            <td mat-cell *matCellDef="let invoice">{{ invoice.expenseDate | date: 'shortDate' }}</td>
          </ng-container>

          <ng-container matColumnDef="amount">
            <th mat-header-cell *matHeaderCellDef class="text-right">Total Amount</th>
            <td mat-cell *matCellDef="let invoice" class="text-right">
              {{ invoice.totalAmount | number: '1.2-2' }} AED
            </td>
          </ng-container>

          <ng-container matColumnDef="outstanding">
            <th mat-header-cell *matHeaderCellDef class="text-right">Outstanding</th>
            <td mat-cell *matCellDef="let invoice" class="text-right">
              <strong class="outstanding-amount">{{ invoice.outstandingAmount | number: '1.2-2' }} AED</strong>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="['select', 'invoiceNumber', 'date', 'amount', 'outstanding']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['select', 'invoiceNumber', 'date', 'amount', 'outstanding']"></tr>
        </table>
      </div>
      <div *ngIf="!loadingPendingExpenseInvoices && pendingExpenseInvoices.length === 0" class="no-invoices">
        <mat-icon>info</mat-icon>
        <span>No pending invoices found for this vendor</span>
      </div>
    </div>

    <!-- Pending Invoices Section for Customer -->
    <div class="pending-invoices-section" *ngIf="isCustomerSelected">
      <h4 class="section-subtitle">
        <mat-icon>receipt</mat-icon>
        Pending Sales Invoices
      </h4>
      <div *ngIf="loadingPendingSalesInvoices" class="loading-state">
        <mat-spinner diameter="24"></mat-spinner>
        <span>Loading pending invoices...</span>
      </div>
      <div *ngIf="!loadingPendingSalesInvoices && pendingSalesInvoices.length > 0" class="invoices-table-container">
        <table mat-table [dataSource]="pendingSalesInvoices" class="pending-invoices-table">
          <ng-container matColumnDef="select">
            <th mat-header-cell *matHeaderCellDef>Select</th>
            <td mat-cell *matCellDef="let invoice">
              <button
                mat-icon-button
                color="primary"
                (click)="selectSalesInvoice(invoice)"
                matTooltip="Select this invoice"
              >
                <mat-icon>check_circle</mat-icon>
              </button>
            </td>
          </ng-container>

          <ng-container matColumnDef="invoiceNumber">
            <th mat-header-cell *matHeaderCellDef>Invoice #</th>
            <td mat-cell *matCellDef="let invoice">
              <strong>{{ invoice.invoiceNumber || 'N/A' }}</strong>
            </td>
          </ng-container>

          <ng-container matColumnDef="date">
            <th mat-header-cell *matHeaderCellDef>Date</th>
            <td mat-cell *matCellDef="let invoice">{{ invoice.invoiceDate | date: 'shortDate' }}</td>
          </ng-container>

          <ng-container matColumnDef="amount">
            <th mat-header-cell *matHeaderCellDef class="text-right">Total Amount</th>
            <td mat-cell *matCellDef="let invoice" class="text-right">
              {{ invoice.totalAmount | number: '1.2-2' }} AED
            </td>
          </ng-container>

          <ng-container matColumnDef="outstanding">
            <th mat-header-cell *matHeaderCellDef class="text-right">Outstanding</th>
            <td mat-cell *matCellDef="let invoice" class="text-right">
              <strong class="outstanding-amount">{{ getInvoiceOutstanding(invoice) | number: '1.2-2' }} AED</strong>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="['select', 'invoiceNumber', 'date', 'amount', 'outstanding']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['select', 'invoiceNumber', 'date', 'amount', 'outstanding']"></tr>
        </table>
      </div>
      <div *ngIf="!loadingPendingSalesInvoices && pendingSalesInvoices.length === 0" class="no-invoices">
        <mat-icon>info</mat-icon>
        <span>No pending invoices found for this customer</span>
      </div>
    </div>

    <!-- Sub-Account (for sub-heads like Prepaid Rent) -->
    <mat-form-field appearance="outline" class="full">
      <mat-label>Sub-Account (Optional)</mat-label>
      <input matInput formControlName="subAccount" placeholder="e.g., Prepaid Rent, Prepaid Commission" />
      <mat-hint>Use for sub-heads under main accounts (e.g., Prepaid Rent under Prepaid Expenses)</mat-hint>
    </mat-form-field>

    <!-- VAT Amount -->
    <mat-form-field appearance="outline">
      <mat-label>VAT Amount (AED)</mat-label>
      <input matInput type="number" formControlName="vatAmount" step="0.01" min="0" placeholder="0.00" />
    </mat-form-field>

    <!-- VAT Tax Type -->
    <mat-form-field appearance="outline">
      <mat-label>VAT Tax Type</mat-label>
      <mat-select formControlName="vatTaxType">
        <mat-option value="standard">Standard Rate</mat-option>
        <mat-option value="zero_rated">Zero Rated</mat-option>
        <mat-option value="exempt">Exempt</mat-option>
        <mat-option value="reverse_charge">Reverse Charge</mat-option>
      </mat-select>
    </mat-form-field>

    <!-- Reference Number -->
    <mat-form-field appearance="outline" class="full">
      <mat-label>Reference Number</mat-label>
      <input matInput formControlName="referenceNumber" placeholder="e.g., Transaction ID, Invoice #" />
    </mat-form-field>

    <!-- Attachment (placeholder for future implementation) -->
    <mat-form-field appearance="outline" class="full" *ngIf="false">
      <mat-label>Attachment</mat-label>
      <input matInput formControlName="attachmentId" type="file" />
    </mat-form-field>

    <!-- Notes -->
    <mat-form-field appearance="outline" class="full">
      <mat-label>Notes</mat-label>
      <textarea matInput formControlName="notes" rows="3"></textarea>
    </mat-form-field>
  </div>
</form>

<mat-dialog-actions align="end">
  <button mat-button (click)="cancel()" [disabled]="loading">Cancel</button>
  <button
    mat-raised-button
    color="primary"
    (click)="save()"
    [disabled]="form.invalid || loading || !isBalanced"
  >
    <mat-spinner *ngIf="loading" diameter="20" class="inline-spinner"></mat-spinner>
    <span *ngIf="!loading">{{ isEditMode ? 'Update' : 'Create' }} Entry</span>
  </button>
</mat-dialog-actions>
