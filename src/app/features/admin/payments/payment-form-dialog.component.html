<h2 mat-dialog-title>Create Payment</h2>

<mat-dialog-content>
  <form [formGroup]="form" class="payment-form">
    <!-- Expense Selection -->
    <div class="form-section">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Select Expense *</mat-label>
        <mat-select 
          formControlName="expenseId" 
          required
          [disabled]="loadingExpenses"
        >
          <mat-option value="">
            <em>Select an expense</em>
          </mat-option>
          <mat-option 
            *ngFor="let expense of expensesWithOutstanding" 
            [value]="expense.id"
          >
            <div class="expense-option">
              <div class="expense-option-main">
                <span class="vendor-name">{{ expense.vendorName || 'N/A' }}</span>
                <span class="expense-amount">
                  {{ expense.totalAmount | number: '1.2-2' }} {{ expense.currency || 'AED' }}
                </span>
              </div>
              <div class="expense-option-details">
                <span class="expense-date">{{ expense.expenseDate | date: 'shortDate' }}</span>
                <span class="outstanding-badge">
                  Outstanding: {{ expense.outstandingAmount | number: '1.2-2' }} {{ expense.currency || 'AED' }}
                </span>
              </div>
            </div>
          </mat-option>
        </mat-select>
        <mat-spinner *ngIf="loadingExpenses" diameter="20" matSuffix class="loading-spinner"></mat-spinner>
        <mat-error *ngIf="form.get('expenseId')?.hasError('required')">
          Please select an expense
        </mat-error>
      </mat-form-field>

      <!-- Selected Expense Details -->
      <div class="expense-details-card" *ngIf="selectedExpense">
        <div class="card-header">
          <h3>Expense Details</h3>
          <button 
            mat-icon-button 
            type="button"
            (click)="clearExpenseSelection()"
            matTooltip="Clear selection"
            aria-label="Clear expense selection"
            class="clear-button"
          >
            <mat-icon>close</mat-icon>
          </button>
        </div>
        <div class="card-content">
          <div class="detail-row">
            <span class="detail-label">Vendor:</span>
            <span class="detail-value">{{ selectedExpense.vendorName || 'N/A' }}</span>
          </div>
          <div class="detail-row" *ngIf="selectedExpense.vendorTrn">
            <span class="detail-label">Vendor TRN:</span>
            <span class="detail-value">{{ selectedExpense.vendorTrn }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Total Amount:</span>
            <span class="detail-value">
              {{ selectedExpense.totalAmount | number: '1.2-2' }} {{ selectedExpense.currency || 'AED' }}
            </span>
          </div>
          <div class="detail-row highlight">
            <span class="detail-label">Outstanding Balance:</span>
            <span class="detail-value outstanding">
              {{ selectedExpense.outstandingAmount | number: '1.2-2' }} {{ selectedExpense.currency || 'AED' }}
            </span>
          </div>
          <div class="detail-row" *ngIf="selectedExpense.description">
            <span class="detail-label">Description:</span>
            <span class="detail-value">{{ selectedExpense.description }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Payment Details -->
    <div class="form-section" *ngIf="selectedExpense">
      <h3 class="section-title">Payment Details</h3>
      
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Payment Amount *</mat-label>
        <input
          matInput
          type="number"
          formControlName="amount"
          step="0.01"
          min="0.01"
          [max]="selectedExpense.outstandingAmount"
          placeholder="Enter payment amount"
        />
        <span matSuffix>{{ selectedExpense.currency || 'AED' }}</span>
        <mat-hint>
          Maximum: {{ selectedExpense.outstandingAmount | number: '1.2-2' }} {{ selectedExpense.currency || 'AED' }}
        </mat-hint>
        <mat-error *ngIf="form.get('amount')?.hasError('required')">
          Payment amount is required
        </mat-error>
        <mat-error *ngIf="form.get('amount')?.hasError('max')">
          Payment cannot exceed outstanding amount of {{ selectedExpense.outstandingAmount | number: '1.2-2' }} {{ selectedExpense.currency || 'AED' }}
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Payment Date *</mat-label>
        <input
          matInput
          [matDatepicker]="paymentDatePicker"
          formControlName="paymentDate"
          placeholder="Select payment date"
          required
        />
        <mat-datepicker-toggle matIconSuffix [for]="paymentDatePicker"></mat-datepicker-toggle>
        <mat-datepicker #paymentDatePicker></mat-datepicker>
        <mat-error *ngIf="form.get('paymentDate')?.hasError('required')">
          Payment date is required
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Payment Method</mat-label>
        <mat-select formControlName="paymentMethod">
          <mat-option *ngFor="let method of paymentMethods" [value]="method.value">
            {{ method.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Reference Number</mat-label>
        <input
          matInput
          formControlName="referenceNumber"
          placeholder="e.g., Transaction ID, Cheque #"
        />
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Notes</mat-label>
        <textarea 
          matInput 
          formControlName="notes" 
          rows="3"
          placeholder="Additional notes about this payment"
        ></textarea>
      </mat-form-field>
    </div>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="!loadingExpenses && expensesWithOutstanding.length === 0">
      <mat-icon>receipt_long</mat-icon>
      <p>No expenses with outstanding balance found</p>
      <p class="empty-state-hint">Create an expense first to record payments against it.</p>
    </div>
  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="cancel()" [disabled]="loading">Cancel</button>
  <button
    mat-raised-button
    color="primary"
    (click)="save()"
    [disabled]="form.invalid || loading || !selectedExpense"
  >
    <mat-spinner *ngIf="loading" diameter="20" class="inline-spinner"></mat-spinner>
    <span *ngIf="!loading">Create Payment</span>
  </button>
</mat-dialog-actions>
