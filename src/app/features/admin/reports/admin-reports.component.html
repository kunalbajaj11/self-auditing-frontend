<section class="reports-container">
  <!-- Report Configuration View -->
  <div class="report-config" *ngIf="selectedReport && !generatedReport">
    <div class="config-header">
      <div>
        <h2>
          <mat-icon [style.color]="selectedReport.color">{{ selectedReport.icon }}</mat-icon>
          {{ selectedReport.label }}
        </h2>
        <p>{{ selectedReport.description }}</p>
      </div>
    </div>

    <mat-card class="config-card" [formGroup]="form">
      <mat-card-content>
        <div class="form-grid">
          <!-- Date Range -->
          <div class="form-section">
            <h3 class="section-title">
              <mat-icon>date_range</mat-icon>
              Date Range
            </h3>
            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Preset</mat-label>
                <mat-select formControlName="dateRangePreset" (selectionChange)="onDateRangePresetChange($event.value)">
                  <mat-option *ngFor="let preset of dateRangePresets" [value]="preset.value">
                    {{ preset.label }}
                  </mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Start Date</mat-label>
                <input matInput [matDatepicker]="startPicker" formControlName="startDate" />
                <mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
                <mat-datepicker #startPicker></mat-datepicker>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>End Date</mat-label>
                <input matInput [matDatepicker]="endPicker" formControlName="endDate" />
                <mat-datepicker-toggle matIconSuffix [for]="endPicker"></mat-datepicker-toggle>
                <mat-datepicker #endPicker></mat-datepicker>
              </mat-form-field>
            </div>
          </div>

          <!-- Additional Filters (conditional based on report type) -->
          <div class="form-section" *ngIf="selectedReport.value === 'payables' || selectedReport.value === 'receivables'">
            <h3 class="section-title">
              <mat-icon>filter_list</mat-icon>
              Filters
            </h3>
            <div class="form-row">
              <mat-form-field appearance="outline" *ngIf="selectedReport.value === 'payables'">
                <mat-label>Status</mat-label>
                <mat-select formControlName="status" multiple>
                  <mat-option value="pending_settlement">Pending Settlement</mat-option>
                  <mat-option value="settled">Settled</mat-option>
                  <mat-option value="auto_settled">Auto Settled</mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline" *ngIf="selectedReport.value === 'receivables'">
                <mat-label>Payment Status</mat-label>
                <mat-select formControlName="paymentStatus" multiple>
                  <mat-option value="unpaid">Unpaid</mat-option>
                  <mat-option value="partial">Partial</mat-option>
                  <mat-option value="paid">Paid</mat-option>
                </mat-select>
              </mat-form-field>
            </div>
          </div>

          <!-- Export Format -->
          <div class="form-section">
            <h3 class="section-title">
              <mat-icon>download</mat-icon>
              Export Format
            </h3>
            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Format</mat-label>
                <mat-select formControlName="format">
                  <mat-option *ngFor="let option of formatOptions" [value]="option.value">
                    <mat-icon>{{ option.icon }}</mat-icon>
                    {{ option.label }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button mat-raised-button color="primary" (click)="generate()" [disabled]="loading" class="generate-btn">
            <mat-progress-spinner *ngIf="loading" [diameter]="20" mode="indeterminate" class="btn-spinner"></mat-progress-spinner>
            <mat-icon *ngIf="!loading">assessment</mat-icon>
            <span>{{ loading ? 'Generating...' : 'Generate Report' }}</span>
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Generated Report View -->
  <div class="report-results" *ngIf="selectedReport && generatedReport" #reportPreviewCard>
    <div class="results-header">
      <div>
        <h2>
          <mat-icon [style.color]="selectedReport.color">{{ selectedReport.icon }}</mat-icon>
          {{ selectedReport.label }}
        </h2>
        <p>Generated on {{ generatedReport.generatedAt | date: 'medium' }}</p>
      </div>
      <div class="download-actions">
        <button mat-stroked-button (click)="generateAndDownload('pdf')" [disabled]="loading">
          <mat-icon>picture_as_pdf</mat-icon>
          PDF
        </button>
        <button mat-stroked-button (click)="generateAndDownload('xlsx')" [disabled]="loading">
          <mat-icon>table_chart</mat-icon>
          Excel
        </button>
        <button mat-stroked-button (click)="generateAndDownload('csv')" [disabled]="loading">
          <mat-icon>description</mat-icon>
          CSV
        </button>
      </div>
    </div>

    <mat-card class="report-preview-card">
      <mat-card-content>
        <!-- Trial Balance Report -->
        <div *ngIf="generatedReport.type === 'trial_balance'">
          <div class="report-summary" *ngIf="generatedReport.data.summary">
            <div class="summary-card">
              <div class="summary-label">Total Debit</div>
              <div class="summary-value">{{ formatCurrency(generatedReport.data.summary.totalDebit) }}</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">Total Credit</div>
              <div class="summary-value">{{ formatCurrency(generatedReport.data.summary.totalCredit) }}</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">Balance</div>
              <div class="summary-value">{{ formatCurrency(generatedReport.data.summary.totalBalance) }}</div>
            </div>
          </div>

          <!-- Charts -->
          <div class="charts-container" *ngIf="trialBalanceChartData || trialBalanceAccountsChartData">
            <div class="chart-wrapper" *ngIf="trialBalanceChartData">
              <h4>Debit vs Credit Overview</h4>
              <canvas baseChart
                [data]="trialBalanceChartData"
                [type]="'bar'"
                [options]="chartOptions">
              </canvas>
            </div>
            <div class="chart-wrapper" *ngIf="trialBalanceAccountsChartData">
              <h4>Top Accounts by Balance</h4>
              <canvas baseChart
                [data]="trialBalanceAccountsChartData"
                [type]="'pie'"
                [options]="pieChartOptions">
              </canvas>
            </div>
          </div>

          <table mat-table [dataSource]="generatedReport.data.accounts" class="report-table">
            <ng-container matColumnDef="accountName">
              <th mat-header-cell *matHeaderCellDef>Account Name</th>
              <td mat-cell *matCellDef="let row">{{ row.accountName }}</td>
            </ng-container>
            <ng-container matColumnDef="accountType">
              <th mat-header-cell *matHeaderCellDef>Type</th>
              <td mat-cell *matCellDef="let row">{{ row.accountType }}</td>
            </ng-container>
            <ng-container matColumnDef="debit">
              <th mat-header-cell *matHeaderCellDef class="text-right">Debit</th>
              <td mat-cell *matCellDef="let row" class="text-right">{{ formatCurrency(row.debit) }}</td>
            </ng-container>
            <ng-container matColumnDef="credit">
              <th mat-header-cell *matHeaderCellDef class="text-right">Credit</th>
              <td mat-cell *matCellDef="let row" class="text-right">{{ formatCurrency(row.credit) }}</td>
            </ng-container>
            <ng-container matColumnDef="balance">
              <th mat-header-cell *matHeaderCellDef class="text-right">Balance</th>
              <td mat-cell *matCellDef="let row" class="text-right">{{ formatCurrency(row.balance) }}</td>
            </ng-container>
            <tr mat-header-row *matHeaderRowDef="['accountName', 'accountType', 'debit', 'credit', 'balance']"></tr>
            <tr mat-row *matRowDef="let row; columns: ['accountName', 'accountType', 'debit', 'credit', 'balance']"></tr>
          </table>
        </div>

        <!-- Balance Sheet Report -->
        <div *ngIf="generatedReport.type === 'balance_sheet'">
          <div class="report-summary" *ngIf="generatedReport.data.summary">
            <div class="summary-card">
              <div class="summary-label">Total Assets</div>
              <div class="summary-value">{{ formatCurrency(generatedReport.data.summary.totalAssets) }}</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">Total Liabilities</div>
              <div class="summary-value">{{ formatCurrency(generatedReport.data.summary.totalLiabilities) }}</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">Total Equity</div>
              <div class="summary-value">{{ formatCurrency(generatedReport.data.summary.totalEquity) }}</div>
            </div>
          </div>

          <!-- Charts -->
          <div class="charts-container" *ngIf="balanceSheetChartData || balanceSheetAssetsChartData">
            <div class="chart-wrapper" *ngIf="balanceSheetChartData">
              <h4>Assets, Liabilities & Equity</h4>
              <canvas baseChart
                [data]="balanceSheetChartData"
                [type]="'pie'"
                [options]="pieChartOptions">
              </canvas>
            </div>
            <div class="chart-wrapper" *ngIf="balanceSheetAssetsChartData">
              <h4>Assets Breakdown</h4>
              <canvas baseChart
                [data]="balanceSheetAssetsChartData"
                [type]="'bar'"
                [options]="chartOptions">
              </canvas>
            </div>
          </div>

          <div class="balance-sheet-sections">
            <div class="section">
              <h3>Assets</h3>
              <table mat-table [dataSource]="generatedReport.data.assets.items" class="report-table">
                <ng-container matColumnDef="category">
                  <th mat-header-cell *matHeaderCellDef>Category</th>
                  <td mat-cell *matCellDef="let row">{{ row.category }}</td>
                </ng-container>
                <ng-container matColumnDef="amount">
                  <th mat-header-cell *matHeaderCellDef class="text-right">Amount</th>
                  <td mat-cell *matCellDef="let row" class="text-right">{{ formatCurrency(row.amount) }}</td>
                </ng-container>
                <tr mat-header-row *matHeaderRowDef="['category', 'amount']"></tr>
                <tr mat-row *matRowDef="let row; columns: ['category', 'amount']"></tr>
              </table>
              <div class="section-total">Total Assets: {{ formatCurrency(generatedReport.data.assets.total) }}</div>
            </div>

            <div class="section">
              <h3>Liabilities</h3>
              <table mat-table [dataSource]="generatedReport.data.liabilities.items" class="report-table">
                <ng-container matColumnDef="vendor">
                  <th mat-header-cell *matHeaderCellDef>Vendor</th>
                  <td mat-cell *matCellDef="let row">{{ row.vendor }}</td>
                </ng-container>
                <ng-container matColumnDef="amount">
                  <th mat-header-cell *matHeaderCellDef class="text-right">Amount</th>
                  <td mat-cell *matCellDef="let row" class="text-right">{{ formatCurrency(row.amount) }}</td>
                </ng-container>
                <tr mat-header-row *matHeaderRowDef="['vendor', 'amount']"></tr>
                <tr mat-row *matRowDef="let row; columns: ['vendor', 'amount']"></tr>
              </table>
              <div class="section-total">Total Liabilities: {{ formatCurrency(generatedReport.data.liabilities.total) }}</div>
            </div>
          </div>
        </div>

        <!-- Profit and Loss Report -->
        <div *ngIf="generatedReport.type === 'profit_and_loss'">
          <div class="report-summary" *ngIf="generatedReport.data.summary">
            <div class="summary-card">
              <div class="summary-label">Gross Profit</div>
              <div class="summary-value">{{ formatCurrency(generatedReport.data.summary.grossProfit) }}</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">Total Expenses</div>
              <div class="summary-value">{{ formatCurrency(generatedReport.data.summary.totalExpenses) }}</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">Net Profit</div>
              <div class="summary-value" [class.positive]="generatedReport.data.summary.netProfit >= 0" [class.negative]="generatedReport.data.summary.netProfit < 0">
                {{ formatCurrency(generatedReport.data.summary.netProfit) }}
              </div>
            </div>
            <div class="summary-card" *ngIf="generatedReport.data.summary.netProfitMargin">
              <div class="summary-label">Profit Margin</div>
              <div class="summary-value">{{ generatedReport.data.summary.netProfitMargin }}%</div>
            </div>
          </div>

          <!-- Charts -->
          <div class="charts-container" *ngIf="profitAndLossChartData">
            <div class="chart-wrapper">
              <h4>Revenue vs Expenses</h4>
              <canvas baseChart
                [data]="profitAndLossChartData"
                [type]="'bar'"
                [options]="chartOptions">
              </canvas>
            </div>
            <div class="chart-wrapper" *ngIf="expensesByCategoryChartData">
              <h4>Expenses by Category</h4>
              <canvas baseChart
                [data]="expensesByCategoryChartData"
                [type]="'pie'"
                [options]="pieChartOptions">
              </canvas>
            </div>
          </div>

          <div class="pnl-sections">
            <div class="section">
              <h3>Revenue</h3>
              <div class="section-details">
                <div class="detail-row">
                  <span>Amount:</span>
                  <span>{{ formatCurrency(generatedReport.data.revenue.amount) }}</span>
                </div>
                <div class="detail-row">
                  <span>VAT:</span>
                  <span>{{ formatCurrency(generatedReport.data.revenue.vat) }}</span>
                </div>
                <div class="detail-row total">
                  <span>Total:</span>
                  <span>{{ formatCurrency(generatedReport.data.revenue.total) }}</span>
                </div>
              </div>
            </div>

            <div class="section">
              <h3>Expenses</h3>
              <table mat-table [dataSource]="generatedReport.data.expenses.items" class="report-table">
                <ng-container matColumnDef="category">
                  <th mat-header-cell *matHeaderCellDef>Category</th>
                  <td mat-cell *matCellDef="let row">{{ row.category }}</td>
                </ng-container>
                <ng-container matColumnDef="amount">
                  <th mat-header-cell *matHeaderCellDef class="text-right">Amount</th>
                  <td mat-cell *matCellDef="let row" class="text-right">{{ formatCurrency(row.amount) }}</td>
                </ng-container>
                <ng-container matColumnDef="vat">
                  <th mat-header-cell *matHeaderCellDef class="text-right">VAT</th>
                  <td mat-cell *matCellDef="let row" class="text-right">{{ formatCurrency(row.vat) }}</td>
                </ng-container>
                <ng-container matColumnDef="total">
                  <th mat-header-cell *matHeaderCellDef class="text-right">Total</th>
                  <td mat-cell *matCellDef="let row" class="text-right">{{ formatCurrency(row.total) }}</td>
                </ng-container>
                <tr mat-header-row *matHeaderRowDef="['category', 'amount', 'vat', 'total']"></tr>
                <tr mat-row *matRowDef="let row; columns: ['category', 'amount', 'vat', 'total']"></tr>
              </table>
              <div class="section-total">Total Expenses: {{ formatCurrency(generatedReport.data.expenses.grandTotal) }}</div>
            </div>
          </div>
        </div>

        <!-- Payables Report -->
        <div *ngIf="generatedReport.type === 'payables'">
          <div class="report-summary" *ngIf="generatedReport.data.summary">
            <div class="summary-card">
              <div class="summary-label">Total Items</div>
              <div class="summary-value">{{ generatedReport.data.summary.totalItems }}</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">Total Amount</div>
              <div class="summary-value">{{ formatCurrency(generatedReport.data.summary.totalAmount) }}</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">Overdue Items</div>
              <div class="summary-value">{{ generatedReport.data.summary.overdueItems }}</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">Overdue Amount</div>
              <div class="summary-value">{{ formatCurrency(generatedReport.data.summary.overdueAmount) }}</div>
            </div>
          </div>

          <!-- Chart -->
          <div class="chart-wrapper" *ngIf="payablesChartData">
            <h4>Payables by Vendor</h4>
            <canvas baseChart
              [data]="payablesChartData"
              [type]="'bar'"
              [options]="chartOptions">
            </canvas>
          </div>

          <table mat-table [dataSource]="generatedReport.data.items" class="report-table">
            <ng-container matColumnDef="vendor">
              <th mat-header-cell *matHeaderCellDef>Vendor</th>
              <td mat-cell *matCellDef="let row">{{ row.vendor }}</td>
            </ng-container>
            <ng-container matColumnDef="amount">
              <th mat-header-cell *matHeaderCellDef class="text-right">Amount</th>
              <td mat-cell *matCellDef="let row" class="text-right">{{ formatCurrency(row.amount) }}</td>
            </ng-container>
            <ng-container matColumnDef="expectedDate">
              <th mat-header-cell *matHeaderCellDef>Expected Date</th>
              <td mat-cell *matCellDef="let row">{{ formatDate(row.expectedDate) }}</td>
            </ng-container>
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td mat-cell *matCellDef="let row">
                <span [class.overdue]="row.isOverdue">{{ row.status }}</span>
              </td>
            </ng-container>
            <tr mat-header-row *matHeaderRowDef="['vendor', 'amount', 'expectedDate', 'status']"></tr>
            <tr mat-row *matRowDef="let row; columns: ['vendor', 'amount', 'expectedDate', 'status']"></tr>
          </table>
        </div>

        <!-- Receivables Report -->
        <div *ngIf="generatedReport.type === 'receivables'">
          <div class="report-summary" *ngIf="generatedReport.data.summary">
            <div class="summary-card">
              <div class="summary-label">Total Invoices</div>
              <div class="summary-value">{{ generatedReport.data.summary.totalInvoices }}</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">Total Outstanding</div>
              <div class="summary-value">{{ formatCurrency(generatedReport.data.summary.totalOutstanding) }}</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">Overdue Invoices</div>
              <div class="summary-value">{{ generatedReport.data.summary.overdueInvoices }}</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">Overdue Amount</div>
              <div class="summary-value">{{ formatCurrency(generatedReport.data.summary.overdueAmount) }}</div>
            </div>
          </div>

          <!-- Chart -->
          <div class="chart-wrapper" *ngIf="receivablesChartData">
            <h4>Receivables by Customer</h4>
            <canvas baseChart
              [data]="receivablesChartData"
              [type]="'bar'"
              [options]="chartOptions">
            </canvas>
          </div>

          <table mat-table [dataSource]="generatedReport.data.items" class="report-table">
            <ng-container matColumnDef="invoiceNumber">
              <th mat-header-cell *matHeaderCellDef>Invoice #</th>
              <td mat-cell *matCellDef="let row">{{ row.invoiceNumber }}</td>
            </ng-container>
            <ng-container matColumnDef="customer">
              <th mat-header-cell *matHeaderCellDef>Customer</th>
              <td mat-cell *matCellDef="let row">{{ row.customer }}</td>
            </ng-container>
            <ng-container matColumnDef="total">
              <th mat-header-cell *matHeaderCellDef class="text-right">Total</th>
              <td mat-cell *matCellDef="let row" class="text-right">{{ formatCurrency(row.total) }}</td>
            </ng-container>
            <ng-container matColumnDef="paid">
              <th mat-header-cell *matHeaderCellDef class="text-right">Paid</th>
              <td mat-cell *matCellDef="let row" class="text-right">{{ formatCurrency(row.paid) }}</td>
            </ng-container>
            <ng-container matColumnDef="outstanding">
              <th mat-header-cell *matHeaderCellDef class="text-right">Outstanding</th>
              <td mat-cell *matCellDef="let row" class="text-right">{{ formatCurrency(row.outstanding) }}</td>
            </ng-container>
            <ng-container matColumnDef="dueDate">
              <th mat-header-cell *matHeaderCellDef>Due Date</th>
              <td mat-cell *matCellDef="let row">{{ formatDate(row.dueDate) }}</td>
            </ng-container>
            <ng-container matColumnDef="paymentStatus">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td mat-cell *matCellDef="let row">
                <span [class.overdue]="row.isOverdue">{{ row.paymentStatus }}</span>
              </td>
            </ng-container>
            <tr mat-header-row *matHeaderRowDef="['invoiceNumber', 'customer', 'total', 'paid', 'outstanding', 'dueDate', 'paymentStatus']"></tr>
            <tr mat-row *matRowDef="let row; columns: ['invoiceNumber', 'customer', 'total', 'paid', 'outstanding', 'dueDate', 'paymentStatus']"></tr>
          </table>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</section>
