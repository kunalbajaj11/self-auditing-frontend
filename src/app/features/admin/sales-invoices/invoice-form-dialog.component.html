<h2 mat-dialog-title>
  {{ data ? 'Edit Invoice' : 'Create Invoice' }}
</h2>

<mat-dialog-content class="invoice-form-content">
  <form [formGroup]="form">
    <!-- Header Section -->
    <div class="form-section">
      <h3>Invoice Details</h3>
      <div class="form-row">
        <mat-form-field appearance="outline" class="flex-2">
          <mat-label>Customer</mat-label>
          <mat-select formControlName="customerId" (selectionChange)="onCustomerChange($event.value)">
            <mat-option [value]="null">Select Customer</mat-option>
            <mat-option *ngFor="let customer of customers" [value]="customer.id">
              {{ customer.name }} {{ customer.customerTrn ? '(' + customer.customerTrn + ')' : '' }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>Invoice Date *</mat-label>
          <input matInput [matDatepicker]="invoiceDatePicker" formControlName="invoiceDate" placeholder="Select invoice date" required />
          <mat-datepicker-toggle matIconSuffix [for]="invoiceDatePicker"></mat-datepicker-toggle>
          <mat-datepicker #invoiceDatePicker></mat-datepicker>
          <mat-error *ngIf="form.get('invoiceDate')?.hasError('required')">
            Invoice date is required
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>Due Date</mat-label>
          <input matInput [matDatepicker]="dueDatePicker" formControlName="dueDate" placeholder="Select due date" />
          <mat-datepicker-toggle matIconSuffix [for]="dueDatePicker"></mat-datepicker-toggle>
          <mat-datepicker #dueDatePicker></mat-datepicker>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>Customer Name</mat-label>
          <input matInput formControlName="customerName" placeholder="Or enter manually" />
        </mat-form-field>

        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>Customer TRN</mat-label>
          <input matInput formControlName="customerTrn" />
        </mat-form-field>

        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>Currency</mat-label>
          <mat-select formControlName="currency">
            <mat-option *ngFor="let curr of currencies" [value]="curr">
              {{ curr }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>Status</mat-label>
          <mat-select formControlName="status">
            <mat-option *ngFor="let status of invoiceStatuses" [value]="status">
              {{ getStatusDisplayLabel(status) }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Description</mat-label>
        <textarea matInput formControlName="description" rows="2"></textarea>
      </mat-form-field>
    </div>

    <!-- Commercial Details Section -->
    <div class="form-section">
      <h3>Commercial Details</h3>
      <div class="form-row">
        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>Delivery Note</mat-label>
          <input matInput formControlName="deliveryNote" />
        </mat-form-field>
        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>Supplier's Ref</mat-label>
          <input matInput formControlName="suppliersRef" />
        </mat-form-field>
        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>Other Reference</mat-label>
          <input matInput formControlName="otherReference" />
        </mat-form-field>
      </div>
      <div class="form-row">
        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>Buyer Order No.</mat-label>
          <input matInput formControlName="buyerOrderNo" />
        </mat-form-field>
        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>Dated</mat-label>
          <input
            matInput
            [matDatepicker]="buyerOrderDatePicker"
            formControlName="buyerOrderDate"
            placeholder="Select date"
          />
          <mat-datepicker-toggle
            matIconSuffix
            [for]="buyerOrderDatePicker"
          ></mat-datepicker-toggle>
          <mat-datepicker #buyerOrderDatePicker></mat-datepicker>
        </mat-form-field>
        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>Despatched Through</mat-label>
          <input matInput formControlName="despatchedThrough" />
        </mat-form-field>
      </div>
      <div class="form-row">
        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>Destination</mat-label>
          <input matInput formControlName="destination" />
        </mat-form-field>
        <mat-form-field appearance="outline" class="flex-1 full-width">
          <mat-label>Terms of Delivery</mat-label>
          <textarea
            matInput
            formControlName="termsOfDelivery"
            rows="2"
          ></textarea>
        </mat-form-field>
      </div>
    </div>

    <!-- Line Items Section -->
    <div class="form-section">
      <div class="section-header">
        <h3>Line Items</h3>
        <button mat-button type="button" color="primary" (click)="addLineItem()">
          <mat-icon>add</mat-icon>
          Add Item
        </button>
      </div>

      <div class="line-items-container" formArrayName="lineItems">
        <!-- Shared autocomplete panel -->
        <mat-autocomplete
          #itemAuto="matAutocomplete"
          [displayWith]="displayItemName"
          (optionSelected)="onItemSelected(activeItemIndex !== null ? activeItemIndex : 0, $event.option.value)"
          [panelWidth]="'auto'"
        >
          <mat-option *ngFor="let suggestion of filteredItems$ | async" [value]="suggestion">
            <div class="item-suggestion">
              <span class="item-name">{{ suggestion.itemName }}</span>
              <span *ngIf="suggestion.description" class="item-description">{{ suggestion.description }}</span>
              <span class="item-details">
                {{ form.get('currency')?.value || 'AED' }} {{ suggestion.unitPrice | number: '1.2-2' }} 
                · VAT: {{ suggestion.vatRate }}% 
                · Used {{ suggestion.usageCount }} time{{ suggestion.usageCount !== 1 ? 's' : '' }}
              </span>
            </div>
          </mat-option>
        </mat-autocomplete>

        <table class="line-items-table" *ngIf="lineItems.length > 0">
          <thead>
            <tr>
              <th>Item Name *</th>
              <th>Description</th>
              <th>Qty</th>
              <th>Unit</th>
              <th>Unit Price *</th>
              <th>VAT Rate</th>
              <th>VAT Type</th>
              <th>Amount</th>
              <th>VAT</th>
              <th>Total</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let lineItem of lineItems.controls; let i = index" [formGroupName]="i">
              <td>
                <div class="item-name-autocomplete">
                  <input
                    class="form-input"
                    formControlName="itemName"
                    placeholder="Item name"
                    [matAutocomplete]="itemAuto"
                    (focus)="onItemNameFocus(i)"
                  />
                </div>
                <small class="error-text" *ngIf="lineItem.get('itemName')?.hasError('required') && lineItem.get('itemName')?.touched">
                  Required
                </small>
              </td>
              <td>
                <input class="form-input" formControlName="description" placeholder="Description" />
              </td>
              <td>
                <input class="form-input" type="number" formControlName="quantity" step="0.001" min="0.001" style="width: 70px;" />
              </td>
              <td>
                <input class="form-input" formControlName="unitOfMeasure" placeholder="unit" style="width: 70px;" />
              </td>
              <td>
                <input class="form-input" type="number" formControlName="unitPrice" step="0.01" min="0" style="width: 100px;" />
              </td>
              <td>
                <input class="form-input" type="number" formControlName="vatRate" step="0.01" min="0" max="100" style="width: 70px;" />
              </td>
              <td>
                <select class="form-select" formControlName="vatTaxType" style="width: 120px;">
                  <option *ngFor="let type of vatTaxTypes" [value]="type">
                    {{ type }}
                  </option>
                </select>
              </td>
              <td class="readonly">{{ lineItem.get('amount')?.value | number: '1.2-2' }}</td>
              <td class="readonly">{{ lineItem.get('vatAmount')?.value | number: '1.2-2' }}</td>
              <td class="readonly">{{ lineItem.get('totalAmount')?.value | number: '1.2-2' }}</td>
              <td>
                <button mat-icon-button type="button" color="warn" (click)="removeLineItem(i)">
                  <mat-icon>delete</mat-icon>
                </button>
              </td>
            </tr>
          </tbody>
        </table>

        <div *ngIf="lineItems.length === 0" class="empty-line-items">
          <p>No line items. Click "Add Item" to add items to this invoice.</p>
        </div>
      </div>

      <!-- Totals -->
      <div class="totals-section" *ngIf="lineItems.length > 0">
        <div class="totals-row">
          <span class="total-label">Subtotal:</span>
          <span class="total-value">{{ subtotal | number: '1.2-2' }} {{ form.get('currency')?.value }}</span>
        </div>
        <div class="totals-row">
          <span class="total-label">Total VAT:</span>
          <span class="total-value">{{ totalVat | number: '1.2-2' }} {{ form.get('currency')?.value }}</span>
        </div>
        <div class="totals-row total-amount">
          <span class="total-label">Total Amount:</span>
          <span class="total-value">{{ totalAmount | number: '1.2-2' }} {{ form.get('currency')?.value }}</span>
        </div>
      </div>
    </div>

    <!-- Notes Section -->
    <div class="form-section">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Notes</mat-label>
        <textarea matInput formControlName="notes" rows="3"></textarea>
      </mat-form-field>
    </div>
  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="cancel()" [disabled]="loading">Cancel</button>
  <button
    mat-raised-button
    color="primary"
    (click)="save()"
    [disabled]="form.invalid || loading || lineItems.length === 0"
  >
    <mat-spinner *ngIf="loading" diameter="20" class="inline-spinner"></mat-spinner>
    <span *ngIf="!loading">{{ data ? 'Update' : 'Create' }}</span>
  </button>
</mat-dialog-actions>

