<div class="invoice-form-dialog">
  <header class="dialog-header">
    <div class="header-text">
      <h2 mat-dialog-title>
        <mat-icon>receipt</mat-icon>
        {{ (documentType === 'proforma' ? (invoice ? 'Edit Proforma Invoice' : 'Create Proforma Invoice') : documentType === 'quotation' ? (invoice ? 'Edit Quotation' : 'Create Quotation') : (invoice ? 'Edit Invoice' : 'Create Invoice')) }}
      </h2>
      <p class="dialog-subtitle">
        <ng-container *ngIf="documentType === 'proforma'">
          {{ invoice ? 'Update proforma invoice details and line items.' : 'Create a proforma invoice for your customer.' }}
        </ng-container>
        <ng-container *ngIf="documentType === 'quotation'">
          {{ invoice ? 'Update quotation details and line items.' : 'Create a quotation for your customer.' }}
        </ng-container>
        <ng-container *ngIf="documentType === 'invoice'">
          {{ invoice ? 'Update invoice details and line items.' : 'Create a new sales invoice for your customer.' }}
        </ng-container>
      </p>
    </div>
  </header>

  <mat-dialog-content class="invoice-form-content">
    <form [formGroup]="form">
      <!-- Header: Title + Logo (reference chunk 1) -->
      <div class="form-section header-section">
        <div class="title-row">
          <mat-form-field appearance="outline" class="invoice-title-field">
            <mat-label>{{ documentTitleFieldLabel }}</mat-label>
            <input matInput [formControl]="invoiceTitleControl" [placeholder]="documentTitlePlaceholder" />
          </mat-form-field>
          <div class="logo-block" *ngIf="organization || logoDataUrl">
            <div class="logo-preview" *ngIf="logoDataUrl">
              <img [src]="logoDataUrl" alt="Logo" class="company-logo" />
            </div>
            <div class="logo-placeholder" *ngIf="!logoDataUrl && organization">
              <mat-icon>business</mat-icon>
              <span>Logo from settings</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Document details: No, Date, Due (reference chunk 1) -->
      <div class="form-section invoice-details-section">
        <h3 class="section-title">{{ documentDetailsSectionLabel }}</h3>
        <div class="form-row details-row">
          <mat-form-field appearance="outline" class="invoice-no-field">
            <mat-label>{{ documentNumberLabel }}</mat-label>
            <input
              matInput
              formControlName="invoiceNumber"
              [readonly]="!!invoice && !allowManualInvoiceNumber"
              [placeholder]="!invoice && nextInvoiceNumber ? nextInvoiceNumber : ''"
            />
            <mat-hint *ngIf="!invoice && nextInvoiceNumber">{{ nextNumberHintLabel }} {{ nextInvoiceNumber }}</mat-hint>
          </mat-form-field>
          <mat-form-field appearance="outline" class="date-field">
            <mat-label>{{ documentType === 'invoice' ? 'Invoice Date *' : 'Date *' }}</mat-label>
            <input matInput [matDatepicker]="invoiceDatePicker" formControlName="invoiceDate" required />
            <mat-datepicker-toggle matIconSuffix [for]="invoiceDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #invoiceDatePicker></mat-datepicker>
            <mat-error *ngIf="form.get('invoiceDate')?.hasError('required')">{{ dateRequiredError }}</mat-error>
          </mat-form-field>
          <mat-form-field appearance="outline" class="date-field">
            <mat-label>{{ dueDateLabel }}</mat-label>
            <input matInput [matDatepicker]="dueDatePicker" formControlName="dueDate" />
            <mat-datepicker-toggle matIconSuffix [for]="dueDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #dueDatePicker></mat-datepicker>
          </mat-form-field>
          <mat-form-field appearance="outline" class="date-field">
            <mat-label>Supply date (optional)</mat-label>
            <input matInput [matDatepicker]="supplyDatePicker" formControlName="supplyDate" />
            <mat-datepicker-toggle matIconSuffix [for]="supplyDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #supplyDatePicker></mat-datepicker>
          </mat-form-field>
        </div>
      </div>

      <!-- Billed By / Billed To cards (reference chunk 1) -->
      <div class="form-section billed-section">
        <div class="billed-cards">
          <div class="billed-card">
            <h4 class="billed-title">Billed by <span class="muted">Your details</span></h4>
            <div class="billed-content" *ngIf="organization">
              <p class="business-name">{{ organization.name }}</p>
              <p *ngIf="organization.address">{{ organization.address }}</p>
              <p *ngIf="organization.vatNumber"><strong>VAT (TRN):</strong> {{ organization.vatNumber }}</p>
              <p *ngIf="organization.contactEmail">{{ organization.contactEmail }}</p>
              <p *ngIf="organization.contactPerson">{{ organization.contactPerson }}</p>
            </div>
            <div class="billed-content" *ngIf="!organization">
              <p class="muted">Loading…</p>
            </div>
          </div>
          <div class="billed-card">
            <h4 class="billed-title">Billed to <span class="muted">Client's details</span></h4>
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Select a client</mat-label>
              <mat-select formControlName="customerId" (selectionChange)="onCustomerChange($event.value)">
                <mat-option [value]="null">Select a client</mat-option>
                <mat-option *ngFor="let customer of customers" [value]="customer.id">
                  {{ customer.name }} {{ customer.customerTrn ? '(' + customer.customerTrn + ')' : '' }}
                </mat-option>
              </mat-select>
            </mat-form-field>
            <p class="hint">
              Select client from the list
              <button type="button" mat-button color="primary" class="add-customer-link" (click)="openAddCustomerDialog()">
                <mat-icon>add</mat-icon>
                Add customer
              </button>
            </p>
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Customer name</mat-label>
              <input matInput formControlName="customerName" placeholder="Or enter manually" />
            </mat-form-field>
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Customer TRN</mat-label>
              <input matInput formControlName="customerTrn" />
            </mat-form-field>
          </div>
        </div>
      </div>

      <!-- Currency + Status only (Configure VAT / display options moved to Advanced below) -->
      <div class="form-section settings-row">
        <mat-form-field appearance="outline" class="currency-field">
          <mat-label>Currency *</mat-label>
          <mat-select formControlName="currency">
            <mat-option *ngFor="let curr of currencies" [value]="curr">{{ curr }}</mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field appearance="outline" class="status-field" *ngIf="documentType === 'invoice'">
          <mat-label>Status</mat-label>
          <mat-select formControlName="status">
            <mat-option *ngFor="let status of invoiceStatuses" [value]="status">
              {{ getStatusDisplayLabel(status) }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <!-- Line items: title row, then table + totals row, then Add button below -->
      <div class="form-section line-items-section">
        <h3 class="section-title">Line items</h3>

        <div class="line-items-and-totals-row">
          <div class="line-items-container" formArrayName="lineItems">
          <mat-autocomplete
            #itemAuto="matAutocomplete"
            [displayWith]="displayItemName"
            (optionSelected)="onItemSelected(activeItemIndex !== null ? activeItemIndex : 0, $event.option.value)"
            [panelWidth]="'auto'"
          >
            <mat-option *ngFor="let suggestion of filteredItems$ | async" [value]="suggestion">
              <div class="item-suggestion">
                <span class="item-name">{{ suggestion.itemName }}</span>
                <span class="item-details">
                  {{ form.get('currency')?.value || 'AED' }} {{ suggestion.unitPrice | number:'1.2-2' }} · VAT: {{ suggestion.vatRate }}%
                </span>
              </div>
            </mat-option>
          </mat-autocomplete>

          <table class="line-items-table" *ngIf="lineItems.length > 0">
            <thead>
              <tr>
                <th>Item</th>
                <th>VAT rate</th>
                <th>Quantity</th>
                <th>Rate</th>
                <th>Amount</th>
                <th>VAT</th>
                <th>Total</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let lineItem of lineItems.controls; let i = index" [formGroupName]="i" class="line-item-row">
                <td>
                  <div class="item-name-cell">
                    <input
                      class="form-input"
                      formControlName="itemName"
                      placeholder="Item name / SKU"
                      [matAutocomplete]="itemAuto"
                      (focus)="onItemNameFocus(i)"
                    />
                    <small class="error-text" *ngIf="lineItem.get('itemName')?.hasError('required') && lineItem.get('itemName')?.touched">Required</small>
                  </div>
                  <input class="form-input desc-input" formControlName="description" placeholder="Description" />
                  <select class="form-select unit-select" formControlName="unitOfMeasure">
                    <option value="unit">Unit</option>
                    <option value="kg">kg</option>
                    <option value="hour">hour</option>
                    <option value="day">day</option>
                    <option value="m2">m²</option>
                  </select>
                </td>
                <td class="vat-rate-cell">
                  <span class="vat-rate-input-wrap">
                    <input class="form-input num" type="number" formControlName="vatRate" step="0.01" min="0" max="100" />
                    <span class="vat-rate-suffix">%</span>
                  </span>
                </td>
                <td><input class="form-input num" type="number" formControlName="quantity" step="0.001" min="0.001" /></td>
                <td><input class="form-input num" type="number" formControlName="unitPrice" step="0.01" min="0" /></td>
                <td class="readonly">{{ lineItem.get('amount')?.value | number:'1.2-2' }}</td>
                <td class="readonly">{{ lineItem.get('vatAmount')?.value | number:'1.2-2' }}</td>
                <td class="readonly total-cell">{{ lineItem.get('totalAmount')?.value | number:'1.2-2' }}</td>
                <td class="actions-cell">
                  <button mat-icon-button type="button" (click)="duplicateLineItem(i)" matTooltip="Duplicate">
                    <mat-icon>content_copy</mat-icon>
                  </button>
                  <button mat-icon-button type="button" color="warn" (click)="removeLineItem(i)" matTooltip="Remove">
                    <mat-icon>close</mat-icon>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>

          <div *ngIf="lineItems.length === 0" class="empty-line-items">
            <p>No line items. Click "Add new line" below to add items.</p>
          </div>

          <div class="line-items-actions">
            <button mat-raised-button color="primary" type="button" (click)="addLineItem()">
              <mat-icon>add</mat-icon>
              Add new line
            </button>
          </div>
          </div>

          <!-- Totals sidebar -->
          <div class="totals-sidebar" *ngIf="lineItems.length > 0">
          <div class="totals-card">
            <h4 class="totals-card-title">Show total in PDF</h4>
            <div class="totals-row">
              <span class="total-label">Amount</span>
              <span class="total-value">{{ subtotal | number:'1.2-2' }} {{ form.get('currency')?.value }}</span>
            </div>
            <mat-form-field appearance="outline" class="discount-field">
              <mat-label>Discount</mat-label>
              <input matInput type="number" formControlName="discountAmount" min="0" step="0.01" />
            </mat-form-field>
            <div class="totals-row">
              <span class="total-label">VAT</span>
              <span class="total-value">{{ totalVat | number:'1.2-2' }} {{ form.get('currency')?.value }}</span>
            </div>
            <div class="totals-row total-amount">
              <span class="total-label">Total ({{ form.get('currency')?.value }})</span>
              <span class="total-value">{{ totalAmount | number:'1.2-2' }}</span>
            </div>
          </div>
          <div class="totals-card total-words">
            <h4 class="totals-card-title">Total in words</h4>
            <p class="total-words-value">{{ totalInWords }}</p>
          </div>
          </div>
        </div>
      </div>

      <!-- Commercial details (existing) -->
      <div class="form-section">
        <h3 class="section-title">Commercial details</h3>
        <div class="form-row">
          <mat-form-field appearance="outline" class="flex-1">
            <mat-label>Delivery note</mat-label>
            <input matInput formControlName="deliveryNote" />
          </mat-form-field>
          <mat-form-field appearance="outline" class="flex-1">
            <mat-label>Supplier's ref</mat-label>
            <input matInput formControlName="suppliersRef" />
          </mat-form-field>
          <mat-form-field appearance="outline" class="flex-1">
            <mat-label>Other reference</mat-label>
            <input matInput formControlName="otherReference" />
          </mat-form-field>
        </div>
        <div class="form-row">
          <mat-form-field appearance="outline" class="flex-1">
            <mat-label>Buyer order no.</mat-label>
            <input matInput formControlName="buyerOrderNo" />
          </mat-form-field>
          <mat-form-field appearance="outline" class="flex-1">
            <mat-label>Dated</mat-label>
            <input matInput [matDatepicker]="buyerOrderDatePicker" formControlName="buyerOrderDate" />
            <mat-datepicker-toggle matIconSuffix [for]="buyerOrderDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #buyerOrderDatePicker></mat-datepicker>
          </mat-form-field>
          <mat-form-field appearance="outline" class="flex-1">
            <mat-label>Despatched through</mat-label>
            <input matInput formControlName="despatchedThrough" />
          </mat-form-field>
        </div>
        <div class="form-row">
          <mat-form-field appearance="outline" class="flex-1">
            <mat-label>Destination</mat-label>
            <input matInput formControlName="destination" />
          </mat-form-field>
          <mat-form-field appearance="outline" class="flex-2">
            <mat-label>Terms of delivery</mat-label>
            <textarea matInput formControlName="termsOfDelivery" rows="3"></textarea>
          </mat-form-field>
        </div>
      </div>

      <!-- Notes & description -->
      <div class="form-section">
        <h3 class="section-title">Notes</h3>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Description</mat-label>
          <textarea matInput formControlName="description" rows="3"></textarea>
        </mat-form-field>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Notes</mat-label>
          <textarea matInput formControlName="notes" rows="4"></textarea>
        </mat-form-field>
      </div>

      <!-- Advanced options: header, footer, Configure VAT (display checkboxes), payment & terms -->
      <div class="form-section advanced-section">
        <h3 class="section-title">Advanced options</h3>
        <p class="section-hint">Header, footer, and what to show on the {{ documentWord }}. Override template defaults for this {{ documentWord }} only.</p>

        <mat-expansion-panel class="advanced-panel" [expanded]="advancedOptionsExpanded">
          <mat-expansion-panel-header>
            <mat-panel-title>Header, footer &amp; display options</mat-panel-title>
            <mat-panel-description>{{ documentTitleFieldLabel }}, header text, footer, and show/hide checkboxes</mat-panel-description>
          </mat-expansion-panel-header>

          <div class="advanced-content" formGroupName="displayOptions">
            <div class="advanced-subsection">
              <h4 class="subsection-title">Header (customisable)</h4>
              <div class="advanced-fields">
                <mat-form-field appearance="outline">
                  <mat-label>{{ documentTitleFieldLabel }}</mat-label>
                  <input matInput formControlName="invoiceTitle" [placeholder]="documentTitlePlaceholderShort" />
                </mat-form-field>
                <mat-form-field appearance="outline" class="header-text-field">
                  <mat-label>Header text</mat-label>
                  <input matInput formControlName="invoiceHeaderText" placeholder="Company name or custom header" />
                </mat-form-field>
              </div>
            </div>

            <div class="advanced-subsection">
              <h4 class="subsection-title">What to show on {{ documentWord }}</h4>
              <div class="checkbox-row">
                <mat-checkbox formControlName="invoiceShowCompanyDetails">Show company details</mat-checkbox>
                <mat-checkbox formControlName="invoiceShowVatDetails">Show VAT details</mat-checkbox>
                <mat-checkbox formControlName="invoiceShowBankDetails">Show bank details</mat-checkbox>
                <mat-checkbox formControlName="invoiceShowPaymentTerms">Show payment terms</mat-checkbox>
                <mat-checkbox formControlName="invoiceShowPaymentMethods">Show payment methods</mat-checkbox>
                <mat-checkbox formControlName="invoiceShowTermsConditions">Show terms &amp; conditions</mat-checkbox>
                <mat-checkbox formControlName="invoiceShowFooter">Show footer</mat-checkbox>
              </div>
              <div class="checkbox-row">
                <mat-checkbox formControlName="invoiceShowItemDescription">Show item description</mat-checkbox>
                <mat-checkbox formControlName="invoiceShowItemQuantity">Show item quantity</mat-checkbox>
                <mat-checkbox formControlName="invoiceShowItemUnitPrice">Show unit price</mat-checkbox>
                <mat-checkbox formControlName="invoiceShowItemTotal">Show item total</mat-checkbox>
              </div>
            </div>

            <div class="advanced-subsection">
              <h4 class="subsection-title">Footer &amp; terms (customisable)</h4>
              <div class="advanced-fields">
                <mat-form-field appearance="outline">
                  <mat-label>Default payment terms</mat-label>
                  <input matInput formControlName="invoiceDefaultPaymentTerms" placeholder="e.g. Net 30" />
                </mat-form-field>
                <mat-form-field appearance="outline" class="full-width terms-conditions-field">
                  <mat-label>Terms &amp; conditions</mat-label>
                  <textarea matInput formControlName="invoiceTermsConditions" class="terms-conditions-textarea" rows="6" [placeholder]="'Optional terms for this ' + documentWord"></textarea>
                </mat-form-field>
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Footer text</mat-label>
                  <textarea matInput formControlName="invoiceFooterText" rows="3" [placeholder]="'Text shown at bottom of ' + documentWord"></textarea>
                </mat-form-field>
              </div>
            </div>

            <div class="advanced-subsection signature-subsection">
              <h4 class="subsection-title">Signature</h4>
              <p class="section-hint">Signature from settings (shown on PDF). Upload in Settings → Invoice template.</p>
              <div class="signature-block" *ngIf="organization || signatureDataUrl">
                <div class="signature-preview" *ngIf="signatureDataUrl">
                  <img [src]="signatureDataUrl" alt="Signature" class="signature-image" />
                </div>
                <div class="signature-placeholder" *ngIf="!signatureDataUrl && organization">
                  <mat-icon>draw</mat-icon>
                  <span>Signature from settings</span>
                </div>
              </div>
            </div>
          </div>
        </mat-expansion-panel>
      </div>
    </form>
  </mat-dialog-content>

  <mat-dialog-actions class="dialog-actions" align="end">
    <button mat-button (click)="cancel()" [disabled]="loading">Cancel</button>
    <button mat-button (click)="save(true)" [disabled]="loading || lineItems.length === 0" type="button">
      Save as draft
    </button>
    <button
      mat-raised-button
      color="primary"
      (click)="save(false)"
      [disabled]="loading || lineItems.length === 0"
      class="submit-btn"
      type="button"
    >
      <mat-spinner *ngIf="loading" diameter="20" class="inline-spinner"></mat-spinner>
      <mat-icon *ngIf="!loading">{{ data ? 'save' : 'add_circle' }}</mat-icon>
      <span *ngIf="!loading">{{ data ? 'Update' : 'Save & continue' }}</span>
    </button>
  </mat-dialog-actions>
</div>
