<div class="invoice-preview-container">
  <!-- Header Actions -->
  <div class="preview-header">
    <button mat-stroked-button (click)="goBack()" class="back-button">
      <mat-icon>arrow_back</mat-icon>
      <span>{{ getBackRoute().label }}</span>
    </button>
    <div class="actions">
      <button mat-raised-button color="primary" (click)="downloadPDF()">
        <mat-icon>download</mat-icon>
        Download PDF
      </button>
      <button mat-stroked-button (click)="exportEInvoice('xml')" matTooltip="Export as UBL 2.1 XML for e-invoicing">
        <mat-icon>code</mat-icon>
        Export XML
      </button>
      <button mat-stroked-button (click)="exportEInvoice('json')" matTooltip="Export as JSON for e-invoicing">
        <mat-icon>data_object</mat-icon>
        Export JSON
      </button>
      <button mat-raised-button (click)="printInvoice()">
        <mat-icon>print</mat-icon>
        Print
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
    <p>Loading invoice preview...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-container">
    <mat-icon color="warn">error</mat-icon>
    <p>{{ error }}</p>
    <button mat-raised-button (click)="goBack()">Go Back</button>
  </div>

  <!-- Invoice Preview -->
  <div *ngIf="previewData && !loading" class="invoice-preview">
    <div class="invoice-paper" [style.border-top-color]="getColorScheme()">
      <!-- Logo and Header -->
      <div class="invoice-header">
        <div class="logo-section" *ngIf="logoDataUrl">
          <img
            [src]="logoDataUrl"
            alt="Company Logo"
            class="company-logo"
          />
        </div>
        <div class="header-text-section">
          <h1
            class="invoice-title"
            [style.color]="getColorScheme()"
            *ngIf="previewData.templateSettings.title"
          >
            {{ getInvoiceTitle() }}
          </h1>
          <p
            class="header-text"
            *ngIf="previewData.templateSettings.headerText"
          >
            {{ previewData.templateSettings.headerText }}
          </p>
        </div>
      </div>

      <!-- Company Details -->
      <div
        class="company-details"
        *ngIf="previewData.templateSettings.showCompanyDetails"
      >
        <div class="company-info">
          <h3>{{ previewData.invoice.organization?.name }}</h3>
          <p *ngIf="previewData.invoice.organization?.address">
            {{ previewData.invoice.organization.address }}
          </p>
          <p *ngIf="previewData.invoice.organization?.phone">
            Phone: {{ previewData.invoice.organization.phone }}
          </p>
          <p *ngIf="previewData.invoice.organization?.contactEmail">
            Email: {{ previewData.invoice.organization.contactEmail }}
          </p>
          <p
            *ngIf="
              previewData.templateSettings.showVatDetails &&
              previewData.invoice.organization?.vatNumber
            "
          >
            TRN: {{ previewData.invoice.organization.vatNumber }}
          </p>
        </div>
      </div>

      <!-- Invoice Details: 3-column layout (Customer, Invoice, Commercial) -->
      <div class="invoice-details-section">
        <div class="customer-info">
          <h3>Bill To:</h3>
          <p class="customer-name">
            {{ previewData.invoice.customer?.name || previewData.invoice.customerName || '—' }}
          </p>
          <p *ngIf="previewData.invoice.customer?.customerNumber" class="customer-id">
            Customer ID: {{ previewData.invoice.customer.customerNumber }}
          </p>
          <p *ngIf="previewData.invoice.customer?.address">
            {{ previewData.invoice.customer.address }}
          </p>
          <p *ngIf="previewData.invoice.customer?.phone">
            Phone: {{ previewData.invoice.customer.phone }}
          </p>
          <p *ngIf="previewData.invoice.customer?.email">
            Email: {{ previewData.invoice.customer.email }}
          </p>
          <p
            *ngIf="
              previewData.templateSettings.showVatDetails &&
              (previewData.invoice.customer?.customerTrn || previewData.invoice.customerTrn)
            "
          >
            TRN: {{ previewData.invoice.customer?.customerTrn || previewData.invoice.customerTrn }}
          </p>
        </div>

        <div class="invoice-meta">
          <div class="meta-row">
            <span class="meta-label">{{ (previewData.invoice.status?.toLowerCase() === 'proforma_invoice') ? 'Proforma Invoice Number:' : 'Invoice Number:' }}</span>
            <span class="meta-value">{{
              previewData.invoice.invoiceNumber
            }}</span>
          </div>
          <div class="meta-row">
            <span class="meta-label">{{ (previewData.invoice.status?.toLowerCase() === 'proforma_invoice') ? 'Proforma Invoice Date:' : 'Invoice Date:' }}</span>
            <span class="meta-value">{{
              previewData.invoice.invoiceDate | date: 'mediumDate'
            }}</span>
          </div>
          <div class="meta-row" *ngIf="previewData.invoice.supplyDate && previewData.invoice.supplyDate !== previewData.invoice.invoiceDate">
            <span class="meta-label">Date of Supply:</span>
            <span class="meta-value">{{
              previewData.invoice.supplyDate | date: 'mediumDate'
            }}</span>
          </div>
          <div class="meta-row" *ngIf="previewData.invoice.dueDate">
            <span class="meta-label">Due Date:</span>
            <span class="meta-value">{{
              previewData.invoice.dueDate | date: 'mediumDate'
            }}</span>
          </div>
          <div
            class="meta-row"
            *ngIf="previewData.templateSettings.showPaymentTerms"
          >
            <span class="meta-label">Payment Terms:</span>
            <span class="meta-value">{{
              previewData.templateSettings.paymentTermsDisplay ||
              previewData.templateSettings.customPaymentTerms ||
              previewData.templateSettings.defaultPaymentTerms ||
              'Receivable'
            }}</span>
          </div>
        </div>
        <div class="commercial-meta">
          <h3>Commercial Details</h3>
          <div class="meta-row" *ngIf="previewData.invoice.deliveryNote">
            <span class="meta-label">Delivery Note</span>
            <span class="meta-value">
              {{ previewData.invoice.deliveryNote }}
            </span>
          </div>
          <div class="meta-row" *ngIf="previewData.invoice.suppliersRef">
            <span class="meta-label">Customer Ref number</span>
            <span class="meta-value">
              {{ previewData.invoice.suppliersRef }}
            </span>
          </div>
          <div class="meta-row" *ngIf="previewData.invoice.otherReference">
            <span class="meta-label">Other Reference</span>
            <span class="meta-value">
              {{ previewData.invoice.otherReference }}
            </span>
          </div>
          <div class="meta-row" *ngIf="previewData.invoice.buyerOrderNo">
            <span class="meta-label">Buyer Order No.</span>
            <span class="meta-value">
              {{ previewData.invoice.buyerOrderNo }}
            </span>
          </div>
          <div class="meta-row" *ngIf="previewData.invoice.buyerOrderDate">
            <span class="meta-label">Dated</span>
            <span class="meta-value">
              {{ previewData.invoice.buyerOrderDate | date: 'mediumDate' }}
            </span>
          </div>
          <div class="meta-row" *ngIf="previewData.invoice.despatchedThrough">
            <span class="meta-label">Despatched Through</span>
            <span class="meta-value">
              {{ previewData.invoice.despatchedThrough }}
            </span>
          </div>
          <div class="meta-row" *ngIf="previewData.invoice.destination">
            <span class="meta-label">Destination</span>
            <span class="meta-value">
              {{ previewData.invoice.destination }}
            </span>
          </div>
          <div class="meta-row" *ngIf="previewData.invoice.termsOfDelivery">
            <span class="meta-label">Terms of Delivery</span>
            <span class="meta-value">
              {{ previewData.invoice.termsOfDelivery }}
            </span>
          </div>
        </div>
      </div>

      <!-- Line Items -->
      <div class="line-items-section">
        <table class="line-items-table">
          <thead>
            <tr>
              <th>Item</th>
              <th
                *ngIf="
                  previewData?.templateSettings?.showItemDescription !== false
                "
              >
                Description
              </th>
              <th
                *ngIf="previewData?.templateSettings?.showItemQuantity !== false"
              >
                Qty
              </th>
              <th
                *ngIf="
                  previewData?.templateSettings?.showItemUnitPrice !== false
                "
              >
                Unit Price
              </th>
              <th>VAT %</th>
              <th
                *ngIf="previewData?.templateSettings?.showItemTotal !== false"
              >
                Total
              </th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of previewData.invoice.lineItems">
              <td>
                <div>{{ item.itemName }}</div>
                <div class="line-item-notes" *ngIf="item.notes">{{ item.notes }}</div>
              </td>
              <td
                *ngIf="
                  previewData?.templateSettings?.showItemDescription !== false
                "
              >
                {{ item.description || '—' }}
              </td>
              <td
                *ngIf="previewData?.templateSettings?.showItemQuantity !== false"
              >
                {{ item.quantity }} {{ item.unitOfMeasure || 'unit' }}
              </td>
              <td
                *ngIf="
                  previewData?.templateSettings?.showItemUnitPrice !== false
                "
              >
                {{ item.unitPrice | number: '1.2-2' }}
                {{ previewData.invoice?.currency || 'AED' }}
              </td>
              <td>{{ (item.vatTaxType === 'ZERO_RATED' || item.vatTaxType === 'EXEMPT') ? '0' : (item.vatRate || 5) }}%</td>
              <td
                *ngIf="previewData?.templateSettings?.showItemTotal !== false"
              >
                {{ item.amount | number: '1.2-2' }}
                {{ previewData.invoice?.currency || 'AED' }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Reverse charge statement (UAE VAT) -->
      <div
        class="reverse-charge-statement"
        *ngIf="hasReverseChargeLine()"
      >
        <em>VAT is payable by the recipient under the reverse charge mechanism (UAE VAT Law).</em>
      </div>

      <!-- Totals -->
      <div class="totals-section">
        <div class="totals-row">
          <span class="totals-label">Subtotal:</span>
          <span class="totals-value">
            {{ previewData.invoice.amount | number: '1.2-2' }}
            {{ previewData.invoice?.currency || 'AED' }}
          </span>
        </div>
        <div class="totals-row" *ngIf="getDiscountAmount() > 0">
          <span class="totals-label">Discount:</span>
          <span class="totals-value">
            -{{ getDiscountAmount() | number: '1.2-2' }}
            {{ previewData.invoice?.currency || 'AED' }}
          </span>
        </div>
        <div class="totals-row">
          <span class="totals-label">VAT &#64; {{ getEffectiveVatRate() }}%:</span>
          <span class="totals-value">
            {{ previewData.invoice.vatAmount | number: '1.2-2' }}
            {{ previewData.invoice?.currency || 'AED' }}
          </span>
        </div>
        <div class="totals-row total-line">
          <span class="totals-label">Total Amount:</span>
          <span class="totals-value" [style.color]="getColorScheme()">
            {{ previewData.invoice.totalAmount | number: '1.2-2' }}
            {{ previewData.invoice?.currency || 'AED' }}
          </span>
        </div>
      </div>

      <!-- Amount in words -->
      <div
        class="amount-in-words"
        *ngIf="previewData.amountInWords"
      >
        <div class="amount-in-words-label">
          Amount Chargeable (in words):
        </div>
        <div class="amount-in-words-value">
          {{ previewData.amountInWords }}
        </div>
      </div>

      <!-- Integrity & Compliance -->
      <div
        class="integrity-section"
        *ngIf="previewData?.invoice?.invoiceHash?.hash"
      >
        <h4>Integrity &amp; Compliance</h4>
        <div class="integrity-grid">
          <div class="integrity-label">Invoice Hash (SHA-256)</div>
          <div class="integrity-value">
            <code>{{ previewData.invoice.invoiceHash.hash }}</code>
          </div>
          <div class="integrity-label">Generated On</div>
          <div class="integrity-value">
            {{ previewData.invoice.invoiceHash.generatedAt | date: 'medium' }}
          </div>
        </div>
        <p class="integrity-hint">
          Use this hash to verify the invoice PDF or payload has not been altered.
        </p>
      </div>

      <!-- Default Notes -->
      <div
        class="notes-section"
        *ngIf="previewData.templateSettings.defaultNotes && previewData.templateSettings.defaultNotes.trim().length > 0"
      >
        <h4>Notes</h4>
        <p>{{ previewData.templateSettings.defaultNotes }}</p>
      </div>

      <!-- Terms & Conditions -->
      <div
        class="terms-section"
        *ngIf="
          previewData.templateSettings.showTermsAndConditions &&
          previewData.templateSettings.termsAndConditions &&
          previewData.templateSettings.termsAndConditions.trim().length > 0
        "
      >
        <h4>Terms & Conditions</h4>
        <p>{{ previewData.templateSettings.termsAndConditions }}</p>
      </div>

      <!-- Bank Details - move below terms & conditions -->
      <div
        class="bank-details-section"
        *ngIf="
          previewData.templateSettings.showBankDetails &&
          (previewData.invoice.organization?.bankAccountNumber ||
            previewData.invoice.organization?.bankIban ||
            previewData.invoice.organization?.bankName ||
            previewData.invoice.organization?.bankAccountHolder)
        "
      >
        <h4>Bank Details</h4>
        <p *ngIf="previewData.invoice.organization?.bankAccountHolder">
          Account Holder: {{ previewData.invoice.organization.bankAccountHolder }}
        </p>
        <p *ngIf="previewData.invoice.organization?.bankName">
          Bank: {{ previewData.invoice.organization.bankName }}
        </p>
        <p *ngIf="previewData.invoice.organization?.bankAccountNumber">
          Account Number: {{ previewData.invoice.organization.bankAccountNumber }}
        </p>
        <p *ngIf="previewData.invoice.organization?.bankIban">
          IBAN: {{ previewData.invoice.organization.bankIban }}
        </p>
        <p *ngIf="previewData.invoice.organization?.bankBranch">
          Branch: {{ previewData.invoice.organization.bankBranch }}
        </p>
        <p *ngIf="previewData.invoice.organization?.bankSwiftCode">
          SWIFT Code: {{ previewData.invoice.organization.bankSwiftCode }}
        </p>
      </div>

      <!-- Authorised Signatory -->
      <div class="signatory-section">
        <div class="signatory-block">
          <div class="signatory-for">
            For {{ previewData.invoice.organization?.name || 'the Company' }}
          </div>
          <img
            *ngIf="signatureDataUrl"
            [src]="signatureDataUrl"
            alt="Signature"
            class="signatory-signature"
          />
          <div class="signatory-line"></div>
          <div class="signatory-label">Authorised Signatory</div>
        </div>
      </div>

      <!-- Footer -->
      <div
        class="invoice-footer"
        *ngIf="previewData.templateSettings.showFooter"
      >
        <p>{{ (previewData.templateSettings.footerText && previewData.templateSettings.footerText.trim().length > 0) ? previewData.templateSettings.footerText : 'This is a Computer Generated Invoice' }}</p>
      </div>
    </div>
  </div>
</div>

