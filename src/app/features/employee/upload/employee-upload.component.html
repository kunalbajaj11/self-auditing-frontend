<section class="upload">
  <header class="header">
    <div>
      <h2>Submit Expense</h2>
      <p>Upload receipt details for approval. Finance will review and approve.</p>
    </div>
  </header>

  <mat-card>
    <!-- Upload Usage Indicator -->
    <mat-card *ngIf="uploadUsage$ | async as usage" class="upload-usage-card" 
              [ngClass]="{
                'warning': (usage.usedUploads / usage.totalAllowed) >= 0.8 && usage.remainingUploads > 0,
                'critical': usage.remainingUploads <= 0
              }">
      <mat-card-content>
        <div class="usage-content">
          <mat-icon>{{ usage.remainingUploads <= 0 ? 'error' : 'cloud_upload' }}</mat-icon>
          <div class="usage-text">
            <strong>Upload Usage:</strong>
            <span *ngIf="usage.remainingUploads <= 0" class="critical-text">
              You have reached your upload limit ({{ usage.totalAllowed | number }} uploads). 
              Please contact your administrator or sales team: <a href="mailto:support&#64;selfaccounting.ai">support&#64;selfaccounting.ai</a>
            </span>
            <span *ngIf="usage.remainingUploads > 0">
              {{ usage.usedUploads | number }} of {{ usage.totalAllowed | number }} uploads used 
              ({{ usage.remainingUploads | number }} remaining)
              <span *ngIf="(usage.usedUploads / usage.totalAllowed) >= 0.8" class="warning-text">
                - Running low! Contact administrator to request more uploads.
              </span>
            </span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Premium License Notice -->
    <mat-card *ngIf="(canUploadExpense$ | async) === false && (isEnterprise$ | async) === false" class="license-notice premium-notice">
      <mat-card-content>
        <mat-icon color="warn">info</mat-icon>
        <div>
          <strong>Upload Expense Feature Disabled</strong>
          <p>Upload expense functionality is not available for Premium license. This feature is only available for Enterprise license holders. Please contact your administrator to upgrade.</p>
        </div>
      </mat-card-content>
    </mat-card>

    <form [formGroup]="form" class="form" [class.disabled-form]="(canUploadExpense$ | async) === false">
      <mat-form-field appearance="outline">
        <mat-label>Vendor</mat-label>
        <input matInput formControlName="vendorName" required [disabled]="(canUploadExpense$ | async) === false" />
        <mat-error *ngIf="form.get('vendorName')?.hasError('required')">
          Vendor name is required
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Category</mat-label>
        <mat-select formControlName="categoryId" [disabled]="(canUploadExpense$ | async) === false">
          <mat-option value="">Uncategorized</mat-option>
          <mat-option *ngFor="let category of categories" [value]="category.id">
            {{ category.name }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Amount (AED)</mat-label>
        <input matInput type="number" formControlName="amount" required [disabled]="(canUploadExpense$ | async) === false" />
        <mat-error *ngIf="form.get('amount')?.hasError('required')">
          Amount is required
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>VAT (AED)</mat-label>
        <input matInput type="number" formControlName="vatAmount" [disabled]="(canUploadExpense$ | async) === false" />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Expense Date</mat-label>
        <input matInput [matDatepicker]="expenseDatePicker" formControlName="expenseDate" placeholder="Select expense date" required [disabled]="(canUploadExpense$ | async) === false" />
        <mat-datepicker-toggle matIconSuffix [for]="expenseDatePicker" [disabled]="(canUploadExpense$ | async) === false"></mat-datepicker-toggle>
        <mat-datepicker #expenseDatePicker></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full">
        <mat-label>Description</mat-label>
        <textarea matInput rows="3" formControlName="description" [disabled]="(canUploadExpense$ | async) === false"></textarea>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full" *ngIf="isEnterprise$ | async">
        <mat-label>Receipt URL (optional)</mat-label>
        <input matInput formControlName="attachmentUrl" placeholder="https://..." />
        <mat-hint>Document upload is available for Enterprise license</mat-hint>
      </mat-form-field>
      <mat-card *ngIf="!(isEnterprise$ | async) && (canUploadExpense$ | async) !== false" class="license-notice">
        <mat-card-content>
          <mat-icon color="warn">info</mat-icon>
          <div>
            <strong>Document Upload Feature</strong>
            <p>Document upload is available for Enterprise license holders only. Please contact your administrator to upgrade.</p>
          </div>
        </mat-card-content>
      </mat-card>
    </form>

    <mat-card-actions align="end">
      <button mat-flat-button color="primary" (click)="submit()" [disabled]="loading || (canUploadExpense$ | async) === false">
        <mat-progress-spinner
          *ngIf="loading"
          diameter="20"
          mode="indeterminate"
        ></mat-progress-spinner>
        <span *ngIf="!loading">Submit Expense</span>
      </button>
    </mat-card-actions>
  </mat-card>
</section>

